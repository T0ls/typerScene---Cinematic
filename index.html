<!-----------------------------------------------------------
   Project : TyperScene — Cinematic
   Author  : T0ls — github.com/T0ls
   Repo    : github.com/T0ls/typerScene---Cinematic
   License : CC-BY-4.0
   Version : 1.0.0
------------------------------------------------------------> 
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<!-- Basic SEO -->
		<meta name="description" content="TyperScene is a cinematic playground that simulates code typing: upload a file, choose language and font, and play back the typing with key sounds and syntax highlighting.">
		<link rel="canonical" href="https://t0ls.github.io/typerScene---Cinematic/">
		<meta name="robots" content="index, follow">
		<!-- Google Fonts (JetBrains Mono + Space Mono) -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<!-- Fonts import -->
		<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Bungee&family=Iceland&family=Megrim&family=Orbitron:wght@400;600;700&family=Pixelify+Sans:wght@400;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
		<!-- Site icon -->
		<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsSAAALEgHS3X78AAAavUlEQVR4Xu1dB0BUV9Y+IEhXFBPsJU2jcbNrLFHXEgtK770IgmKwxGjUuHGdxCS22HBjAUSQ3otSY4INjUaTrL/R6CZRMGgiYgmKgLT/nDsMQZx5U5gHQd41N/OGd99t57un3TvvaICQOvUMaHTq0QuDBwEAnRwEAgAEAHTyGejkwxc4gACATj4DnXz4AgcQANDJZ6CTD1/gAAIAOvkMdPLhtzcHaN6+tL60d//UBY8GKRU1/5u0++pqm7Oetp5gau+J3L9/fy1dY+O+PYx6mvYy7dldW0e/e1dtLUP9bt276HbV1tTU0OoCXUCTRoEPsk9x0tBsaNDQ0NRsoPrYNd5l9/FLF/rEv+GTmux+Y1Z4UjUaGuqwygaor6ePOnqwXkODfUI9XTZgov/hN1Z5HSvI2qUSrH1MdXW1NY9r6isePKh/XFv7sKa6uvz2rdLyB3dLf//jjz9u3Lx5s0b8yFNZ4b62pmBbAKCJ4CNGjOiio2M4bMzkSTP+NnrM+FdHvj6yV+/eL+A0ardmEB31WQRM3d3bt4su/3Dhh//7/uzpb44XFlSW3/3vxYsXCUCUJcDgbYh8AkBCeE1c5aaO3n5+Vi5uXqZ9+g7lbTTPQMV3y8qKc9OSYxNiD+wrvnKlBIdEXIc3IPAFAMZynxs8uFfQwqWrbNzc52traetLo09NTQ3c+u0m3CkthfI/7sPDBw+guqoS6O91tbVQV1eHXBgXA05BQwPjrGIuTH8Ts9knsviemFM31OM99iD9p5yY1SCBw/7Df0yK4IA0aVj4HaUNZSaTNMRSSXxPnFAuiT+xjJaWFnTp0gW0tLVBR1cPDI2MwKhbdzB57jkw7dsPdHR0mp5rfoGS53FuZkpU6GcbP7l27doNGlZjllpe1T+qGwASeavl5jvXffFq0WeGRoa9mnfu/t078FVuDnx9rACQ9cGNX69DPRK5MyYCSJ9+/WHoiNdg3KQpMN3CCp7v3eeJqahGnWHPlk3/PpKdGVpUVET6gkQ0qGXK1AkAqqtLN0wf79yza4rZbLfmPbzw7VmIDtkDBfk5UIurW0hPzwBxkYlTp4PP2wthzMRJTxQ4d+pEzuq35/nfvn27DG9IxEKrp1FdAGDE74vp89iktBdeGfaGpGfFV3+BrevWwvHD+a3ubGeqYPSEibDiw08Zd5CkmyW/Xlno42Z77cqVq/i3WszKyTUpE6gOADDi9+kzpF9oanJe/4GDhknaiQ3bCzs3fgKPq6s7E+3UNtYuqD8ELHkXAt99D/UJsV5RVlp6fZ6b/ayi//3vF3WAoLUAYMQ3MjIyjszIyX9h6NBR1Eli8etWLoNDyYlqm4zOXNFbs8xh/echoKuny6bhZknJTz5ONm/dKSm51Vpx0FoAkMNFZ/v+6IgpM81cxMSvhZVvB8DR/NzOTDO1j30MioTgyFgEgR6r+7uvTx3+YPEC+1u3blXhV5UVw9YAgHiStpOXj/fq9ZvDWK9QIomWL4GslCSVJoC0YjKZJGZWk7mlUm1/jYdamqlk1tLfVEmTZ5jB1n2RTSbn55vXr4r4fOdOrOtxIwiUrlZVANBzWqjz9Yk/fPQ7Q0MjE2o5dl8obPtYpFAnSOM10NdniO7atSuzl5vb0gpV0kELkQ+jFn0cjx8/hqrKSqh49KjJryFvSP6Ll0LQe6tYscfVjyvczaaMRvNQZX1AVQAw1v+v9Zs3O3h4LaTOXL92FdxmT5er8NEK72FszBwizJkiJMYRyAF27/595vjiSjR/kRnZ8OrIv7FiX2Ydint/UeB8vCRRoLRDRRUKsNX//IABAzMLCi/gymVC6V3/OVBY8CVn5/VxxT+HHrDOstKVxTZxBrTz4RFyBK70t1GjITw1kxVB7NS6mk97A03Dy/hVsrGkcNOqAIBkv+6CZSvfn7toyb+ppQvffQv+TracjaJ/CExMmKQQkpwZuHPnDpSXl3OW2r7vAEycNp2VSYmK+nzzh/96XxUuoCwAmNmH2eDg8dNne/fr9zJ1YPWiBejezZbZYVr5pqamAuGVmAHU7jk5wejxE2F3TAKrEfdQbjlMnTgcQfMAvyrlIFIFAF2HjfzHqAPpmaeo8fv37oLl+NFMqZGWSGbhbqDA9pUgPhUlcVBSUiJTJyD9KbXgBPQbMJDVvGSOl+WZk8cL8FIpi0BZANDq1/WZv/CdoBUrP6WGM5PiYcMHxH2kp17I9o2Q/QtJ+Rl4gGKgDMWBrLRw5WrwnreA3cZ9ls92bdm4Di8rMSusDCoLAC2s3GDznrADk6bPZEL/gyVBUJCXI7WPpOwNHDhQpraPZiT8/vvvCptAyk9hx36CrIPr13G3tHHru+Voxkz4J+yMjGF//v7smSNBnq4OePmwEQAKORuUAQDT/jF3Sz1y4us+ffsz+e9i9haUFBdJnWkjQ0PohVq/rPTOO++AmZkZbNiwAQoLCzs2tXjqfRlaBQ8eEk2fTt179IDc09+xGw8flJeajX59BF6S9qiwNaAsALoaGBj0+OLc+et46kEbT7vBW68PlymnyOQzRBBwAYBAQOnYsWOwceNGuHLlCk9T2TGrfYjEJ9NQVso98x10627MbttPfvOl0tJSOjxCu29q5wBk/ukMGjRoWFxeAYPdbzdKwGnGFJmd69evH/PyKQIAKkOsLiUlBbZv3w6kBQsJNTr0Ft64QTSVniLSDsErrw5nN/1dnKZevvD9WbyU7A/InUJlOACz/18fNXbSrpi4PKr54vn/QqC7k8xGBg8a1HQ8SlqhYcOGwZo1a2DChAlP3K5E9+i+ffsgNDQUKioq5A7iWS7QgIuiqLhY5hC3hu6Hcf+czO6vWjDP9eTxI2SPkyL45/k5jglSBgBkAejhiRXLjbv2MAP09InjsGJBgNTqNdFMGTR4sEK0GTNmDCxduhTGjx//RHlifTt27ICkpCS5LlKFGuqghYqLiqBexgbS2s3bYKalFRvZJ6tXvZ1/MD0WL8mVqJAloCwA9M2srV3WbNiyjxo8glu+ouVLpU4rbe4MGDBAqSkfO3YsA8Kbb775xHM//fQTbNq0CQoKyMztfOnXX3+V6Wd5T7QObJxd2aRsW/fhexlJ8bQzS2yTFwAYWNg5+q1a9+kOajDvYDpsWLNaKkW08RQsOYBUSQQAUg7HjRv3xONff/01eHp6qlJlh36GHEJ0SlpaWoy+ACevOexWyI4tH8Tt37erEQDSPXMtKlGGA5AJqG/p4DRvhejjLVRPdloyfPbRWqkdI+WPlMDWJBIJ77//PowcObKpmhdeeKE1VXbIZ0kJJGVQWgpcuhzc/cRieP+u/3wUFbp7O58AMLB3dZ+/ZPWazdTgQTzytf1Tcj49nei8Ozl6VE0kQuzt7WHRokVPiJLOCAD8+Rjg8XCpU+m/aAl4BQSyexG7d21EAGzCS3Ic8MIBDFy8fBYsWL5yIzWYkRAHOzetl9oxXV1d6NPnyTPuioCB9g7s7OwY4dHkbHqETMTU1FRYtUp8GKIzpd9++w2qqsiyezr54hFyn/lvsxsHQndvObBnN7noFfYGKisCDDx85y70X/Iu2wdIjY2G3VsZM3gqKQsAIrytrS0j/OAW1sOJEyeYt/DyZdry7nyJCwBzAoPAJ1AMgKi9e7YiCCQAUGhXUFkAGHoFzF/qu2AhO/eVFBUJoTtJ5KgOACK8jY0NI/yQIUOeqIgIToQnAHTmxAUAWv0+8xs3hML27jgQsodkskQEyPUGKg0A74D5q3wCg9j2X9z+MIjYQ0qnagAgs2/9+vXQUq6TF3Dbtm2M5cvaCOlMgOACgDcS30eyI7hvb3BUyN6P+ACA5CCIITa41jsg8F0iQHRYCOa9KgOATD3JXgBVQl6/kJAQCA8PB/IGCkk8A5wAmBfYtCUcEx7CKwDIDDT0mrdA5O0/j+3gROMp4Jh9Ia0GAB2ETExMZF6/sjL66ZuQms8AFwDIAkCuzIpHh4cFx4TxxwEaARAo8porBkBMOAEgtFUAeO2115iX7+effxaoLmMGuAEwH7z8xQCI2U8ACOFNBIgB4B8o8vT3bwRAGMSGi38T0jIpYgXgT8rgAR6HFhL3DHABwNN/HgJgHqsgNjw8GMUA3wCYJ/KYG8AAQMSP3c+2BVQCgEB4xWaAEwBzA4BAQAndwAiAMH4B4OE/T+TpK+YAsRH7qNF2BYCjo6NKew6XLl2Cw4cPK0aBdi7FBQBcjODZ6AqOjQwPjuMdAH7+Ig8/MQDiIsJZbk8OEB8f/9SmkSL0IhNzxYoVihRt9zKcAPDzB6SHmANEIAAiwnnmAAgAd9+5TQCIj9wvAIBniHABAGnRBACkRdsAwM3HlwEg/kAEtDcAJk+ezH5upmwqxlM2586dU/axdikvDwDuc/xYvxKiIvkHgLuvn8jNx68JAAkIgvYUAe1CkTZulAsAbkj8PwEQERwfGcGvCCAAuHrNYQBAxLEsAIBfRHACwMcXkCOzDiTGHGgLAPiKnD3FAEiMjoTEqAMCAPilP6cr2NVnDrh6iwGQHEsAiOSZA/j4ipy8vBkAkqKjEAQCAHimPzcAvOeAi7cP60JKTHRwfBTPAHD18hW5eHmJOUBMFCRhFkQAvxDgEgF4QAdcMbMFGRMTnBjDMwCcvXxELp5iACTFRCPbiRYAwC/9OTmAs6c3uHh5iwEQGxOcHBPFrwhw9vISOXuIRQARPzlW/OPElkmRvQCe5+2ZqZ6LAzh7egGBgNEjLhoBEMM/AJzcPcUAiIuFFAEAvAONCwBOBAAP8VH5lPjYNgCAh5fIwcODASCVAIBZ4AD8YoATAEh8x0YApMXFBSfH8cwBHD08RI5ujQCIj4NUzAIA2g8Aju4eQJktyIS44NS4OH5FADYmcnBzZxwgjQCQEC8AgF/6cyqBjm7u4NAIgLSE+GBckPwDwN7FVQyAxATARgUAtCMAcDGCg6v4zfzpSYn8A8De3V3k4PwnANIRBIII4BcBXDqAPRJfAoC05MTg9Ph4fjkA/jRMZO/izDhAOh7kRNQJAOCX/pwiALkx2LuKfx2cnpQcnJ7YBgCwc3ISAyA5CTIEAPBMfu5j4XYEAGf2onbISElpAwA4u4psncUcIIMAgFkQAfxigEsE2CHxKVPKTEYOkJzIrwiwc3YW2TiKAZCZksyyAID2A4CtkzNQpnQwNTk4IzmZZwA4Oq+xdnJcJm4wBQGQIgCAX/pz6gC2Tk5g4yh+T9OhtFT+AWDj5PSBjYPjctYgHqzMRBAIHIBfBHCJABs8FS0BQFZqSnBGaiq/HMDG3nG1taMjO06blZEmcAB+ac9q5wSAgyNYY6aUnY4cgG8AWNs7rrJ2sGdvacjOzBAA0M4AsLZ3QADQG2JxQaalBx9M55kDWNnar8QG2c/Dcw5mCiKgnQFgha/RsbYTA+BQRlpwVno6byKA3hNoaGlr+x42+AE1mJedhbanYAXwjQEuEWBlZw9WtnZiDnAwg38AWNjYLbe2s1tDDeYTAAQlkG/6c+oAlkh8CQCyD2YGZ2XwzAHMra2XWdvas1AxX2AQaAEAvNOfGwA2tmCJmYnkrIMIgAx+RcBsK6ulCAD2jqDD+KZQdD9KnQHhSJj6gMElAizw/UqW1mIAZGcfCs7hHQAWFu9Y2tl/SA1+lZ8vcAD10VlmTZwAsLYB5Mrs2dys7OCcgzxzgJnm5ouRA7C3Qx758jCkC0og7xDgAoC5lTVQppSXlRWMYoAXEUD1szeEmM22WISWwMf0h6NfEQAEEcA3ArgBYAWzLcUAyCcRkJXFLwBmmJktRNPjE2rw2FdfQbpgBfBNf04lcDa+Kn62paUYADnZwbl8A2D6zFlBVna27E2hx48UCByAd/Jzu4JnW1jCrEYAfJGdE5ybwy8HMJg+c+ZCNDsYAE4cPSpwgHYGwCwLC5hlbsF6cTiXAJDDqwhgALCwtmkCQEZaqtQpEMxA9SGDSwcg4puZm7PG0C+zIz83l9dXxRq8NX16EHIA9orwwmNHISMtTQCA+mgttSZuAJjDzNliACAH2Jafl0f6GW/vCjaYOnXa25Z2NhuowZP4EmfcfhQA0I4AMEPiz5w9q5ED5G9F5xyvbws3mDhp0nxbewf2jvjTp05Bmgw/QGsDRvA8px2qeq6AESQCUCyLOUB+3qbD+fnNA0ao/W3hBuPGj5/n4OT8GTX4zZnTkIoRvaQldYSM6VBU4rGzXCFjLNAMnDJtmpgD5OWu++rwYXp/P38BI0aPHTvXycVlGzX47dlzkCzjhyGtCRrF41x2yKq5gkZZ40bQxMmT2LjysnLWHD1aQO/v5y9kzKhRo1yc3d3ZG6IvnD8PcTHS3w+gSti4DkmdNug0V9g4ezwTOLYxzN7BtLSVGFmNXt7MCwDoQIjBiBEjrDznzGG/Cf8fRvSI3C/9RZHKBI5sgzns0E1wBY50dXeH1//xDza+1MTEhd9++y3RhuIGqj1oFAFAH6N7TA6YH5hFDV6/Xgx7d++WObnyQsd2aKq0UeflhY71nTsXXnllKOtNVHSU5+WLF4k2vAWO1DMxMRm+7L0VZ6jBe/fuwpbN0oNG0X15waPbaA47dDPygkcvXLwYw/OJ4zOG7Nltdv369dN4yUvoWAoerYcevl5r1op+wujk2hTp48O1a6FBRlxbeeHjOzRl2qjz8sLH/wuDb+vr67PebFy//jUsX4yXFG9H7aFjWfRwzD2Wr1hxzNjY+EVqdPvWrXD37l2p02FkaAi9VHiPbxvNbYdopgwDaD94SDrd00lPTw8IAJSqqqvLPl23bhRe3qGvmNUePZwCR+lgNvbw8grH0O9sByIBX9d+6eJFqR3U1NSEgQMHggZGEheS8jNAnBVZuszIaRRtjXQAShhivnB/WBj9SvQ+ZgozygsAtLHi7viG7nfQ+8SOhp/75hs4dOiQzNH1MjEBo27dlB+98AQ8KC+Hsju0oKWnGegBnIRvS6dUWFj4OXoB6aDOH5gp0LBcLyA9p8zSpLLsVBBGBR8XMH9+LlVQgexp65YtMlFKgSEpijhxAyEpPgMUL5EcQKRnyUpLMOxeT1xglKIPHHD/5ZdfvsBLCsKkUNRQZQFA5ZkpiNnk3WXLjnbv3p0F903A9wRd/lF2WFdSUkxNTRUfvVASKHjmo0ekzEtPFFfZr5H9P6qsLAvevv1NDDB9G0vTQwr5AFQBAC1jpgdMmzZtFbIf9p6A4uIiiIyI5CRbNxQDaEIKpFVgBu4g2y9H9s+VXN3cAPUwVuTs2bOROdnZpA3ew6ywAqgKAEgMkB6AEd+MXkEWdARZPAECYqKj4erVq5ydJk5ApqEgDqRPE7H926j1c618erJv377gHxDAlGtUFOtCQ0JmI8f4L94i1NRgVkj+qwIAekYiBnpYWlmtx70B9p7S27dLISw0jFNmsYdRJ+hhbAyGGDNQsA7EQCBt/yHGT7x3/77c+aM58/XzRb1qAHv2x0uXslJSUhbjJdniSrF/VQFAYqAr5m7IBV4MCgrKw61fpuafPHkSCgoKOLmA5CZxAQPkCLpoy9LWsbaWFmh0EkWR3Ls1tbVAXr4qjJFcgbJe0SDZ48ePhxkzZrBprKuvqwrZG2KFIuMH/CrR/hUy/yR0UMYKaP4McQE9zD3feOMNH3Nzc/ZDkQb8l56aBpd+/FEhELQsROgmDkGfzbNKlf1FHqLV3TyTVi/Lcyqvy2T3u6Hsl4jQo8eObis8UfifZqufTAaF2b+qHICeIy7AdAECgaur666XXn6JwbKutg6Sk5MBTRJ54xHuKzEDtK/i4eEBXXWI+QLgFvE3CfEJfshFSPMn049sf6VWf2sAQM8SFyDXcHd0Sfb38fGJ6dXL5GW6UYsgyMzMhMu4XSyk1s/AkCFDgCKk6jQSv7z8QUlkZKQHxl0mrZtYP/n+ifhKrf7WAkDiGCJRYIw+gZe9vDwj8JNpJ8TmTuGZwRMnChWWb62fqmerBhKD48aNhalTpzax/YqKituxsXFzy8rKLuBoye0rUfyUJn5rAUDPkygg76ABcQICAYqDPSYmPdlGEaXS0lKM0fsl82kLSfEZ6NO7N8w0m8m21CUJfQM3EhOTgpD4pPQR8Wnfn8w+pVm/pE5VlMCWo5DoAwwEKA76WllZffLSiy9ObV6wqKgITp85A/SpqhKk+PR13JID0G0+duxYePmVl9FP/yd5fi0pOZuRkbGqcbuX2D4RXyW533x21AEACScgpZDcxGQSdkfrwG3KlMmL0cQzbN4gebiuXL4CV69dk+vu7LhkVLzn9Asq0+efh8GDB8PQYUOhZ8+eTzxcX1dXVXjyVCh6+yJqampo1ZOzh9i+ZOWrxPrVyQEkdUk4ASmGRHQjFAkD/zlhwoLhr42w6qKpSQB5KlVVVTG3Z0XFI6isqmS2cW1NLdTW1UJ9XT3Us8MmrRqj4tRQc0lawRqaGkx+k3mrraWNPg9t0NXVA30DfSD3uD76QWSk+h8vX/7i+PETu+/du0cmFRGeDgaQwke+fpWUvpZtqYsDNAcBWQfkHiZuQGLBsEePHgP//ve/Ow8f/qq5oYHB82qe52eqOjzYcffSpR+/OH/+fDLqTz83Ep3YPa162ueXEF8t41Y3AKhTVCeBgJRDAgJBnMCgh78V0Ovdu/fIQYMGvInn2Eb2NjV9CXUG5UN/q2Xof41KKquq7uGpn59u3Lz5Q3Hx9W/wRyDfI6snYtNKl3wS4YnlK+3okTdKPgAgAUFzIJD3gsBA4oE+6TuJBC2UgQYoKvrgRlEvPT0dIy2troa6yCe7aGt31dBowHKaKD2QjzY0aIIG5o6Q6lFmaWrWoXu3QaOhoQYFWS2mmurqmsf19TWPKiuqyiurq++g6PsdlTpi7bSqicCk1BGxJZm+Nye82mUhXwCQkInqpywxF4krUCbiMwBgJm5BmcpQljwj6RvffeQTUs0JJlFm6JPkN2Va0ZQJABIQEMHpWnKPVyWorSa3OVElhJb2yUX8tuqrugDRkvhUb0sQ0HcitAQQks/m5dTVH6n1tMekNl/Zsq6bd7Y9+qjOSW/JtiXfm6/sltfqbJ+zrr/S5P6V+tIWBFC7PFel051t0lWZo2f6GQEAzzR55Q9OAID8OXqmSwgAeKbJK39wAgDkz9EzXUIAwDNNXvmDEwAgf46e6RICAJ5p8sof3P8DY0x5JurxhKIAAAAASUVORK5CYII=">

		<title>TyperScene — Cinematic</title>
		<style>
		/* ---------- Root variables (unified) ---------- */
		:root{
			/* theme */
			--bg:#000000;
			--panel:#061014;
			--text:#b6ffb6;
			--accent:#39ff14;
			--muted:#6f9a6f;
			--mono:"JetBrains Mono","Fira Code","Courier New",monospace;

			/* tabs */
			--tab-border: rgba(255,255,255,0.12);
			--tab-hover:  rgba(57,255,20,0.35);
			--tab-active-bg: linear-gradient(180deg,#2a30345c,#041018);

			--cursor-stroke: clamp(1px, 0.10em, 3px);
			/* help browsers prefer dark controls */
			color-scheme: dark;

			/* new font */
			--ui-orbitron: "Orbitron", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
			--ui-pixelify: "Pixelify Sans", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
			--ui-bungee: "Bungee", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
			--ui-audiowide: "Audiowide", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
			--ui-iceland: "Iceland", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
			--ui-megrim: "Megrim", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
			--ui-syncopate: "Syncopate", Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;

			/* (opzionale) mapping logico per headings/body */
			--font-head: var(--ui-orbitron);
			--font-sans: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
		}

		/* ---------- Base / Layout ---------- */
		html,body{
			margin:0;
			min-height:100%;
			color:var(--text);
			font-family:var(--mono);
			-webkit-font-smoothing:antialiased;
		}
		html{ background:#000; }
		body{
			min-height:100vh;
			background: linear-gradient(180deg,#000 0%, #021218 60%) fixed no-repeat;
			background-size: 100% 100%;
		}
		.container{display:flex;min-height:100vh;gap:18px;padding:18px 18px 24px;box-sizing:border-box;transition:all .25s ease}

		/* left column + code palette vars */
		.left{
			flex:1;
			display:flex;
			flex-direction:column;
			gap:14px;
			transition:all .25s ease;

			--code-mono:"JetBrains Mono",monospace;
			--kw:#7fffb5; --type:#7ee0ff; --str:#ffd19a; --num:#ffb3b3;
			--comment:#6a7b6a; --fn:#ffd1ff; --punct:#cfe8ff; --loglevel:#ffb86b;
			--code-color:#b6ffb6;               /* default code color */
			--cursor-color: var(--code-color);   /* cursor inherits code color */
		}

		header{display:flex;align-items:center;gap:12px}
		header h1{font-size:20px;margin:0;color:var(--accent);letter-spacing:1px}
		.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
		.controls label{font-size:13px;color:var(--muted)}
		.btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--text);cursor:pointer}
		.small{font-size:13px;padding:6px 8px}

		/* ---------- Preview / Screen ---------- */
		.preview{
			position:relative;
			min-height:400px;
			flex:0 0 auto;
			background: radial-gradient(circle at 10% 10%, rgba(57,255,20,0.03), rgba(255,255,255,0.01)), #020405;
			border-radius:10px;
			padding:18px;
			overflow:hidden;
			box-shadow:0 12px 40px rgba(0,0,0,0.8);
			border:1px solid rgba(57,255,20,0.04);
		}
		.noCursor{ cursor:none; }

		.screen-wrap{position:relative;min-height:320px;max-height:calc(100vh - 220px);overflow:auto}
		#screen{
			white-space:pre-wrap;
			font-size:18px;
			line-height:1.25;
			margin:0;
			color:var(--code-color);
			font-family:var(--code-mono) !important;
			text-shadow:0 1px 0 rgba(0,0,0,0.6);
			padding-bottom:40px;
			overflow-wrap:anywhere;
			overflow-y:auto;
			overflow-x:hidden;
			word-break:break-word;
			hyphens:auto;
			transition: font-family .3s ease;
			animation: slightFlicker 6s infinite;
		}
		@keyframes slightFlicker{
		0%{opacity:.98;filter:hue-rotate(0deg) contrast(1)}
		3%{opacity:.92;filter:hue-rotate(0deg) contrast(.98)}
		6%{opacity:.98;filter:hue-rotate(1deg) contrast(1.02)}
		100%{opacity:.99;filter:hue-rotate(0deg) contrast(1)}
		}

		/* ---------- Syntax tokens ---------- */
		.kw{color:var(--kw)}
		.type{color:var(--type)}
		.str{color:var(--str)}
		.num{color:var(--num)}
		.comment{color:var(--comment);font-style:italic}
		.fn{color:var(--fn)}
		.punct{color:var(--punct)}
		.loglevel{color:var(--loglevel)}

		/* Monocolore: usa solo --code-color */
		.mono #screen .kw,
		.mono #screen .type,
		.mono #screen .str,
		.mono #screen .num,
		.mono #screen .comment,
		.mono #screen .fn,
		.mono #screen .punct,
		.mono #screen .loglevel { color: inherit !important; }

		/* ---------- Right column ---------- */
		.right{width:360px;display:flex;flex-direction:column;gap:12px;transition:all .25s ease}

		/* ---------- Generic panel ---------- */
		.panel{
			background:linear-gradient(180deg,#041018,var(--panel));
			padding:12px;
			border-radius:10px;
			box-shadow:0 6px 24px rgba(0,0,0,0.6);
			box-sizing:border-box;
		}
		input[type="file"]{color:var(--muted)}
		.chip{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;font-size:13px}
		.footer{font-size:12px;color:var(--muted);margin-top:6px}

		/* ---------- Selects (global) ---------- */
		select,
		#fontSelect,#modeSelect,#cursorSelect{
			appearance:none;-webkit-appearance:none;-moz-appearance:none;
			width:100%;box-sizing:border-box;
			background-color:rgba(255,255,255,0.03);
			border:1px solid rgba(57,255,20,0.12);
			color:var(--text);
			border-radius:8px;
			padding:8px 34px 8px 10px;
			font-family:var(--mono);
			line-height:1.2;
			background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%2339ff14'><path d='M7 10l5 5 5-5z'/></svg>");
			background-repeat:no-repeat;
			background-position:right 10px center;
			background-size:12px;
		}
		select:hover,
		#fontSelect:hover,#modeSelect:hover,#cursorSelect:hover{ border-color:rgba(57,255,20,0.3) }
		select:focus,
		#fontSelect:focus,#modeSelect:focus,#cursorSelect:focus{ outline-offset:2px;border-color:rgba(57,255,20,0.6) }
		select:disabled{ opacity:.55;cursor:not-allowed }
		select option{ background-color:#041018;color:var(--text) }
		select.btn{ background-color:rgba(255,255,255,0.03) }

		/* ---------- Panels: specific ---------- */
		#audioPanel{ margin-top:10px }
		#audioPanel button{ font-family:var(--mono) }
		input[type="range"]{ accent-color:#39ff14; cursor:pointer }

		#sourcePanel{ margin-top:12px; flex-shrink:0 }
		#sourcePanel textarea{
			resize:vertical;
			min-height:120px;
			max-height:450px;
			background:#020b0d;
			color:var(--muted);
			flex:1 1 auto;
			min-height:0;
			width:100%;
			border:0;
			border-radius:8px;
			padding:8px;
		}

		#fontSelect{
			background:rgba(255,255,255,0.03);
			color:var(--text);
			border:1px solid rgba(255,255,255,0.05);
			border-radius:8px;
			font-family:var(--mono);
		}
		#fontPanel{ margin-top:12px; overflow:hidden; align-self:flex-start !important; height:auto !important; padding-bottom:8px }
		#fontPanel label{ font-family:var(--mono) }
		#fontPanel .font-stack{ display:flex; flex-direction:column; gap:12px; margin-top:8px; min-height:0; overflow:auto; overflow-x:hidden }
		#fontPanel .font-row{ display:flex; flex-direction:column; gap:6px }
		#fontPanel .field-label{ font-size:13px; color:var(--muted); font-family:var(--mono) }
		#fontPanel .w-full{ width:100% }
		#fontPanel select{ background:rgba(255,255,255,0.03); color:var(--text); border:1px solid rgba(255,255,255,0.05); border-radius:8px; font-family:var(--mono) }
		#fontPanel input[type="range"]{ accent-color:#39ff14; cursor:pointer }

		#chunkRange{ accent-color:#39ff14 }

		.field-value{ font-size:12px; color:var(--muted); align-self:flex-end }
		/* ---------- Subpanels grid (editor area) ---------- */
		#sourcePanel{ grid-column:1; grid-row:1 / span 2 }
		.subpanels .panel{ display:flex; flex-direction:column }

		/* dynamics layout */
		#dynamicsPanel .dyn-stack{ display:flex; flex-direction:column; gap:12px; margin-top:8px }
		#dynamicsPanel .dyn-row{ display:flex; flex-direction:column; gap:6px }
		#dynamicsPanel .field-label{ font-size:13px; color:var(--muted); font-family:var(--mono) }
		#dynamicsPanel input[type="range"]{ accent-color:#39ff14; cursor:pointer }

		/* helpers */
		.subpanel,.subpanel-grid{ align-items:start } /* avoid equal-height stretching */
		.control-row{ display:flex; align-items:center; gap:10px }
		.control-row input[type="range"]{ flex:1 }
		.hint{ font-size:12px; color:var(--muted); opacity:.9; margin-top:4px }

		/* ---------- Theme picker / BG tiles ---------- */
		.theme-grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px }
		.theme-btn{
			background:rgba(255,255,255,0.03);
			border:1px solid rgba(255,255,255,0.06);
			border-radius:8px;
			padding:6px 8px;
			font-size:13px; color:var(--text);
			cursor:pointer; font-family:var(--mono);
			height:48px;
		}
		.theme-btn:hover{ border-color:rgba(57,255,20,0.4) }

		.bg-grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; width:100% }
		.bg-tile{
			position:relative; height:56px; border-radius:8px;
			border:1px solid rgba(255,255,255,0.08); cursor:pointer; overflow:hidden;
		}
		.bg-tile:hover{ border-color:rgba(57,255,20,0.45) }
		.bg-tile.active{ outline-offset:2px; border-color:rgba(57,255,20,0.5) }
		.bg-tile::after{
			content:attr(data-name);
			position:absolute; left:6px; bottom:6px;
			font-family:var(--mono); font-size:11px; color:rgba(255,255,255,0.80);
			background:rgba(0,0,0,0.35); padding:2px 6px; border-radius:6px;
		}

		/* ---------- Tabs (Bootstrap-ish) ---------- */
		.tabs{
			display:flex; gap:0; flex-wrap:wrap; margin:0 0 10px 0;
			border-bottom:1px solid var(--tab-border);
		}
		.tab-btn{
			appearance:none; background:transparent; color:var(--text);
			font-family:var(--mono); font-size:13px; cursor:pointer;
			border:1px solid transparent; border-bottom:none;
			border-top-left-radius:10px; border-top-right-radius:10px;
			padding:8px 14px; margin-bottom:-1px;
		}
		.tab-btn:hover{ color:var(--text); border-color:var(--tab-hover); border-bottom-color:transparent }
		.tab-btn.active{ background:var(--tab-active-bg); border-color:var(--tab-border); border-bottom-color:transparent }
		.tab-content{ padding-top:10px }
		.tab-content.hidden{ display:none }

		/* ---------- Preview overlays ---------- */
		.preview::after{
			content:""; position:absolute; inset:0; pointer-events:none; background:none; box-shadow:none;
		}
		.preview.bg-scanlines::after{
			background: repeating-linear-gradient(
				0deg,
				rgba(255,255,255,0.22) 0px,
				rgba(255,255,255,0.22) 1px,
				transparent 1px,
				transparent 3px
				);
			opacity:.45; mix-blend-mode:soft-light;
		}
		.preview.bg-vignette::after{
			box-shadow: inset 0 0 180px rgba(0,0,0,0.55), inset 0 0 60px rgba(0,0,0,0.35);
		}

		/* ---------- Cursor (base + variants) ---------- */
		@keyframes blink{0%{opacity:1}50%{opacity:.15}100%{opacity:1}}
		@keyframes pulse{
		0%,100%{ box-shadow:0 0 12px var(--cursor-color), 0 0 24px color-mix(in srgb, var(--cursor-color) 60%, transparent) }
		50%{    box-shadow:0 0 18px var(--cursor-color), 0 0 36px color-mix(in srgb, var(--cursor-color) 75%, transparent) }
		}

		/* Base (fallback visible even without variant) */
		.cursor{
			position:absolute; top:0; left:0;
			width: 1ch;
			height: var(--lh, 20px);
			background:var(--cursor-color);
			opacity:.95; border-radius:2px;
			box-shadow:
				0 0 12px var(--cursor-color),
				0 0 24px color-mix(in srgb, var(--cursor-color) 60%, transparent);
			animation: blink 1s steps(2) infinite, pulse 2s infinite;
			pointer-events:none; user-select:none;
			will-change: top,left,opacity;
			font-family: var(--code-mono);
			transition:none !important;
			z-index:5;
		}

		/* Variants override size/shape */
		.cursor--bar{ width: var(--cursor-stroke); height: var(--lh,20px); background: var(--cursor-color) }
		.cursor--vintage{ width: 1ch; height: calc(var(--lh,20px)/2); background: var(--cursor-color); transform: translateY(calc(var(--lh, 20px) / 2 - var(--cursor-stroke))); }
		.cursor--underline{ width: 1ch; height: var(--cursor-stroke); background: var(--cursor-color); transform: translateY(calc(var(--lh, 20px) - var(--cursor-stroke))); }
		.cursor--double{ width: 1ch; height: var(--cursor-stroke); background: var(--cursor-color); transform: translateY(calc(var(--lh,20px) - 4px)); box-shadow: 0 calc(var(--cursor-stroke) * 2) 0 var(--cursor-color); }
		.cursor--box{ width: 1ch; height: var(--lh,20px); background: var(--cursor-color); }
		.cursor--box-empty{ width: 1ch; height: var(--lh,20px); border: var(--cursor-stroke) solid var(--cursor-color); background: transparent; }
		.cursor.no-blink{ animation:none !important; }

		/* Cursor select panel hidden in clean mode */
		.clean #cursorPanel{ display:none !important }

		/* ---------- Color picker panel ---------- */
		#colorPanel{ margin-top:10px }
		.swatch-grid{ display:grid; grid-template-columns:repeat(6,24px); gap:8px }
		.swatch{
			width:24px; height:24px; border-radius:6px;
			border:1px solid rgba(255,255,255,0.15);
			background:var(--sw); cursor:pointer;
		}
		.swatch:focus-visible{ outline:2px solid #39ff14; outline-offset:2px }

		/* ---------- Stats side panel (clean+F10) ---------- */
		.clean .preview{ display:block !important; position:relative }
		#statsPanel{
			display:none; position:fixed; right:0; top:0;
			width:35vw; min-width:300px; height:100vh; padding:10px 12px; box-sizing:border-box;
			border-left:1px solid rgba(255,255,255,0.06);
			background: linear-gradient(180deg, rgba(3,16,21,0.85), rgba(3,16,21,0.85)), var(--preview-bg);
			backdrop-filter: blur(2px);
			z-index:50; overflow:hidden;
		}
		.clean.stats-on #statsPanel{ display:block }
		.clean.stats-on .preview{ padding-right:calc(35vw + 20px) !important }
		.clean.stats-on #screen{ white-space:pre-wrap !important; overflow-wrap:anywhere; word-break:break-word }

		.stats-grid{ display:grid; gap:10px; grid-template-rows:repeat(4,1fr); height:100% }
		.tile{
			background: linear-gradient(180deg,#08141a,#031015);
			border:1px solid rgba(255,255,255,0.08);
			border-radius:10px;
			padding:8px 10px;
			box-shadow:0 6px 18px rgba(0,0,0,0.45);
			display:flex; flex-direction:column; gap:6px;
			min-height:0;
		}
		.tile-h{ font-size:12px; color:var(--muted); display:flex; justify-content:space-between }
		.tile-m{ font-size:12px; color:var(--muted); opacity:.9 }
		#statsPanel canvas{
			width:100%; height:auto; aspect-ratio:16/5; image-rendering:crisp-edges;
			background: radial-gradient(circle at 10% 10%, rgba(57,255,20,0.03), rgba(255,255,255,0.01));
			border-radius:6px;
		}
		.stack-view{
			margin:0; padding:6px 8px; background:rgba(0,0,0,0.25);
			border-radius:6px; font-family:var(--mono); font-size:12px; line-height:1.25; color:var(--text);
			white-space:pre; overflow:auto; flex:1 1 auto; min-height:0;
		}

		/* ---------- Clean / Cinema mode ---------- */
		.clean-body{ background:#000 !important }
		.clean header,.clean .controls,.clean .right,.clean .footer{ display:none !important }
		.clean .preview{
			border-radius:0 !important; padding:28px !important; box-shadow:none !important; border:0 !important;
			width:100vw; height:100vh; overflow:hidden auto;
		}
		.clean .screen-wrap{
			min-height:100vh; max-height:100vh; display:flex; align-items:flex-start; justify-content:flex-start;
			padding-top:28px; box-sizing:border-box; overflow:hidden auto;
		}
		.clean #screen{ font-size:22px; padding-bottom:0 }
		.clean .cursor{ height:26px; width:12px }
		.clean #screen::selection{ background:transparent }
		.clean::-webkit-scrollbar,
		.clean *::-webkit-scrollbar{ width:0; height:0 }
		.clean, .clean *{ scrollbar-width:none !important; -ms-overflow-style:none !important }
		.clean #editorSubpanels,
		.clean #hotkeysPanel,
		.clean #colorPanel{ display:none !important }

		/* ---------- Footer ---------- */
		.site-footer{
			margin-top:12px; padding:10px 18px;
			background: linear-gradient(180deg,#041018,#060d12);
			border-top:1px solid rgba(255,255,255,0.06);
			color:var(--muted); text-align:center;
		}
		.footer-content{
			max-width:1200px; margin:0 auto;
			display:flex; align-items:center; justify-content:center; gap:12px; flex-wrap:wrap;
		}
		.gh-link{ display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text); opacity:.9 }
		.gh-link:hover{ opacity:1 }
		.gh-link svg{ width:18px; height:18px; fill:currentColor }
		.gh-username{ font-family:var(--mono); font-size:13px; color:var(--muted) }
		.clean .site-footer{ display:none !important }
		@media (max-width:520px){ .footer-content{ flex-direction:column } }

		/* ---------- Responsive helpers ---------- */
		@media (max-width:1100px){
			.subpanels{ grid-template-columns:1fr }
		}
		@media (max-width:900px){
			.right{ width:260px }
			#screen{ font-size:16px }
		}

/* Griglia che affianca Source (sinistra) e la colonna destra */
.subpanel-grid{
  display: grid;
  grid-template-columns: 2fr 1fr;  /* Source 2/3, colonna destra 1/3 */
  gap: 12px;
  align-items: stretch;            /* stesse altezze di colonna */
}

/* Colonna destra: 3 righe (Font auto, Typing 1fr, Rewind 1fr) */
.sub-right{
  display: grid;
  grid-template-rows: auto 1fr 1fr;
  gap: 12px;
  height: 100%;
}

/* Card generiche */
.panel{ display:flex; flex-direction:column; }

/* Font: deve occupare SOLO lo spazio necessario */
#fontPanel{
  align-self: start;
  height: auto;
  min-height: 0;
  padding-bottom: 8px;
}

/* Le due card “stirabili” per riempire lo spazio */
#typingPanel, #rewindPanel{
  min-height: 0; /* importante in grid */
}

/* Utility controlli */
.control-row{ display:flex; align-items:center; gap:10px; }
.control-row input[type="range"]{ flex:1; }
.hint{ font-size:12px; color:var(--muted); opacity:.9; margin:6px 0 4px; }

		</style>
	</head>
	<body>
		<div id="bigBoy" class="container">
			<div class="left">
				<header>
					<h1>TyperScene — Cinematic</h1>
					<div class="controls">
						<label class="chip">Press any key → code appears</label>
						<button id="clearBtn" class="btn small">Clear (Esc)</button>
						<button id="restartBtn" class="btn small">Rewind</button>
						<button id="cleanBtn" class="btn small" title="Fullscreen">⛶ Fullscreen</button>
					</div>
				</header>

				<!-- Preview panel -->
				<div class="preview panel" tabindex="0" id="preview">
					<div class="screen-wrap">
						<pre id="screen"></pre>
						<div class="cursor" id="cursor"></div>

						<!-- Right-side stats (Clean + F10) -->
						<aside id="statsPanel" aria-hidden="true">
							<div class="stats-grid">
								<div class="tile">
									<div class="tile-h">CPU load <span id="cpuNow">0.20</span></div>
									<canvas id="cpuChart" width="340" height="110"></canvas>
									<div class="tile-m">1m / 5m / 15m: <span id="cpuAvg">0.22 / 0.18 / 0.16</span></div>
								</div>

								<div class="tile">
									<div class="tile-h">Memory <span id="memNow">0.0 / 8.0 GB</span></div>
									<canvas id="memChart" width="340" height="110"></canvas>
									<div class="tile-m"><span id="memBreak">used / cache / free</span></div>
								</div>

								<div class="tile">
									<div class="tile-h">Network <span id="netNow">↑ 0.0 MB/s • ↓ 0.0 MB/s</span></div>
									<canvas id="netChart" width="340" height="110"></canvas>
									<div class="tile-m">Uptime: <span id="uptimeLbl">0d 00:00:00</span></div>
								</div>

								<!-- Stack -->
								<div class="tile">
									<div class="tile-h">Stack Monitor</div>
									<pre id="stackView" class="stack-view"></pre>
								</div>
							</div>
						</aside>
					</div>
				</div>


				<div id="editorSubpanels" style="margin-top: 0" class="subpanel-grid">
					<!-- Source text panel -->
					<div class="panel" id="sourcePanel">
						<label class="chip">Source Text</label>
						<label style="font-size:13px;color:var(--muted)">Edit text:</label>
						<textarea id="source" style="width:97%;margin-top:8px;background:#021218;color:var(--muted);border-radius:8px;padding:8px;border:0;"></textarea>
					</div>

					<!-- Colonna destra accanto a Source text -->
					<div id="subRight" class="sub-right">
						<!-- Font Panel -->
						<div class="panel" id="fontPanel">
							<label class="chip">Font</label>

							<div class="control">
								<div class="hint">Select code font:</div>
								<select id="fontSelect" class="btn small" style="flex:1;max-width:240px">
									<option value="'JetBrains Mono', monospace">JetBrains Mono</option>
									<option value="'Ubuntu Mono', monospace">Ubuntu Mono</option>
									<option value="'Anonymous Pro', monospace">Anonymous Pro</option>
									<option value="'Major Mono Display', monospace">Major Mono Display</option>
									<option value="'Nova Mono', monospace">Nova Mono</option>
									<option value="'VT323', monospace">VT323</option>
									<option value="var(--ui-orbitron)">Orbitron</option>
									<option value="var(--ui-pixelify)">Pixelify Sans</option>
									<option value="var(--ui-bungee)">Bungee</option>
									<option value="var(--ui-audiowide)">Audiowide</option>
									<option value="var(--ui-iceland)">Iceland</option>
									<option value="var(--ui-megrim)">Megrim</option>
									<option value="var(--ui-syncopate)">Syncopate</option>
								</select>
								<div id="fontSelectWrap"></div>
							</div>

							<div class="control">
								<div class="hint">Font size</div>
								<div class="control-row">
									<input id="fontSizeRange" type="range" min="12" max="28" step="1">
									<span id="fontSizeVal" class="field-value">18px</span>
								</div>
							</div>
						</div>

						<!-- Typing Panel -->
						<div class="panel" id="typingPanel">
							<label class="chip">Typing</label>

							<div class="control">
								<div class="hint">Chunk per key</div>
								<div class="control-row">
									<input id="chunkRange" type="range" min="1" max="12" step="1">
									<span id="chunkVal" class="field-value">1</span>
								</div>
							</div>

							<div class="control" id="burstBlock">
								<div class="hint">Burst delay</div>
								<div class="control-row">
									<input id="burstDelayRange" type="range" min="1" max="60" step="1" value="12">
									<span id="burstDelayVal" class="field-value">12ms</span>
								</div>
							</div>
						</div>

						<!-- Rewind Panel -->
						<div class="panel" id="rewindPanel">
							<label class="chip">Rewind</label>

							<div class="control">
								<div class="hint">Rewind speed</div>
								<div class="control-row">
									<input id="rewindSpeedRange" type="range" min="1" max="20" step="1">
									<span id="rewindSpeedVal" class="field-value">x5</span>
								</div>
							</div>

							<label class="chip" style="display:flex;align-items:center;gap:8px;margin-top:8px">
								<input type="checkbox" id="rewindAnimChk" checked>
								Rewind animation
							</label>
						</div>
					</div>
				</div>
			</div>

			<div class="right">
				<!-- Source panel -->
				<div class="panel" id="sourceModePanel">
					<div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
						<div><label class="chip">Source / Mode</label></div>
						<div class="tog">
							<label for="generate">Generate random</label>
							<input type="checkbox" id="generate" />
						</div>
					</div>

					<div style="margin-top:10px">
						<input type="file" id="fileInput" accept=".js,.py,.java,.html,.htm,.css,.ts,.cs,.cpp,.cc,.h,.c,.sql,.php,.go,.rs,.kt,.swift,.r,.sh,.rb,.dart,.m,.json,.yml,.yaml,.xml,.md,.tex,.pl,.lua,.hs,.scala,.asm"/>
					</div>

					<div style="margin-top:10px">
						<label class="chip">Language</label>
						<div style="display:flex;gap:8px;margin-top:6px">
							<select id="modeSelect" class="btn small">
								<option value="py">Python</option>
								<option value="rust">Rust</option>
								<option value="java">Java</option>
								<option value="sql">SQL</option>
								<option value="asm">Assemby x86</option>
							</select>
							<button id="copyBtn" class="btn small">Copy all</button>
						</div>
					</div>
				</div>

				<!-- Audio panel -->
				<div class="panel" id="audioPanel">
					<label class="chip">Audio Settings</label>
					<div style="display:flex;flex-direction:column;gap:10px;margin-top:8px">

						<div>
							<label style="font-size:13px;color:var(--muted)">Upload custom sound</label><br>
							<input type="file" id="soundFileInput" accept="audio/*" />
						</div>

						<div style="display:flex;align-items:center;gap:10px;margin-top:6px">
							<button id="toggleSoundBtn" class="btn small" style="min-width:90px">🔊 Sound On</button>
							<span id="soundFileLabel" style="font-size:13px;color:var(--muted)">Default click</span>
							<button id="resetAudioBtn" class="btn small">Reset Audio</button>
						</div>

						<div style="display:flex;align-items:center;gap:10px;margin-top:6px">
							<label style="font-size:13px;color:var(--muted)">Volume:</label>
							<input type="range" id="volumeRange" min="0" max="100" value="50" style="flex:1">
							<span id="volumeVal" style="font-size:13px;color:var(--muted)">50%</span>
						</div>

					</div>
				</div>

				<!-- Aspect Panel -->
				<div class="panel" id="colorPanel">
					<div class="tabs">
						<button class="tab-btn active" data-tab="tabThemes">Themes</button>
						<button class="tab-btn" data-tab="tabColor">Text</button>
						<button class="tab-btn" data-tab="tabBg">Background</button>
					</div>

					<!-- TAB 1: THEMES -->
					<div id="tabThemes" class="tab-content">
						<div class="theme-grid" style="margin-top:8px">
							<button class="theme-btn" data-theme="default">Default Neon</button>
							<button class="theme-btn" data-theme="monokaiBlack">Monokai Black</button>
							<button class="theme-btn" data-theme="matrixGreen">Matrix Green</button>
							<button class="theme-btn" data-theme="terminalSea">Terminal Sea</button>
							<button class="theme-btn" data-theme="carbonWarm">Carbon Warm</button>
							<button class="theme-btn" data-theme="draculaGlass">Dracula Glass</button>
						</div>
					</div>

					<!-- TAB 2: TEXT -->
					<div id="tabColor" class="tab-content hidden">
						<div id="colorSwatches" class="swatch-grid">
							<!-- verdi -->
							<button class="swatch" data-color="#b6ffb6" style="--sw:#b6ffb6" title="#b6ffb6"></button>
							<button class="swatch" data-color="#39ff14" style="--sw:#39ff14" title="#39ff14"></button>
							<button class="swatch" data-color="#00ffa2" style="--sw:#00ffa2" title="#00ffa2"></button>
							<!-- azzurri/blu -->
							<button class="swatch" data-color="#7ee0ff" style="--sw:#7ee0ff" title="#7ee0ff"></button>
							<button class="swatch" data-color="#55ccff" style="--sw:#55ccff" title="#55ccff"></button>
							<button class="swatch" data-color="#82aaff" style="--sw:#82aaff" title="#82aaff"></button>
							<!-- ambra/arancio -->
							<button class="swatch" data-color="#ffd19a" style="--sw:#ffd19a" title="#ffd19a"></button>
							<button class="swatch" data-color="#ffb86b" style="--sw:#ffb86b" title="#ffb86b"></button>
							<!-- viola/rosa -->
							<button class="swatch" data-color="#ffd1ff" style="--sw:#ffd1ff" title="#ffd1ff"></button>
							<button class="swatch" data-color="#ff9de6" style="--sw:#ff9de6" title="#ff9de6"></button>
							<!-- bianco / grigi -->
							<button class="swatch" data-color="#cfe8ff" style="--sw:#cfe8ff" title="#cfe8ff"></button>
							<button class="swatch" data-color="#e6f6e6" style="--sw:#e6f6e6" title="#e6f6e6"></button>
						</div>

						<div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap">
							<input id="colorHexInput" class="btn small" placeholder="#39ff14" style="min-width:120px">
							<button id="applyColorBtn" class="btn small">Apply</button>
							<label class="chip" style="display:flex;align-items:center;gap:6px">
								<input type="checkbox" id="monoColor"> Monochrome text
							</label>
						</div>
					</div>

					<!-- TAB 3: BACKGROUND -->
					<div id="tabBg" class="tab-content hidden">
						<div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap">
							<div id="bgGrid" class="bg-grid" style="margin-top:8px">
								<button class="bg-tile" data-preset="default" data-name="Default"
									style="background: radial-gradient(circle at 10% 10%, rgba(57,255,20,0.03), rgba(255,255,255,0.01)), #020405;"></button>
								<button class="bg-tile" data-preset="solid-black" data-name="Solid black"
									style="background:#000;"></button>
								<button class="bg-tile" data-preset="deep-green" data-name="Deep green"
									style="background: radial-gradient(circle at 20% 15%, rgba(57,255,20,0.06), transparent 40%), #04140a;"></button>
								<button class="bg-tile" data-preset="terminal-ice" data-name="Terminal-ice"
									style="background:
										linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.95)),
										radial-gradient(circle at 12% 10%, rgba(57,255,20,0.05), rgba(255,255,255,0.01)),
										#0c0f12;"></button>
								<button class="bg-tile" data-preset="carbon" data-name="Carbon fiber"
									style="background: repeating-linear-gradient(45deg, #0b0b0b 0 6px, #0f0f0f 6px 12px);"></button>
								<button class="bg-tile" data-preset="terminal-glass" data-name="Terminal glass"
									style="background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75)), rgba(2,4,5,0.35);"></button>
							</div>

							<input id="bgHexInput" class="btn small" placeholder="#0a0f0a" style="min-width:120px">
							<button id="applyBgHexBtn" class="btn small">Apply</button>

							<label class="chip" style="display:flex;align-items:center;gap:6px">
								<input type="checkbox" id="bgScanlinesChk"> Scanlines
							</label>
							<label class="chip" style="display:flex;align-items:center;gap:6px">
								<input type="checkbox" id="bgVignetteChk"> Vignette
							</label>
						</div>
					</div>
				</div>

				<!-- Cursor panel -->
				<div class="panel" id="cursorPanel">
					<label class="chip">Cursor Style</label>
					<div class="cursor-stack" style="display:flex;flex-direction:column;gap:10px;margin-top:8px">
						<label class="field-label">Select cursor</label>
						<select id="cursorSelect" class="btn small w-full">
							<option value="default">Default ( █ )</option>
							<option value="vintage">Vintage (▄)</option>
							<option value="bar">Bar (|)</option>
							<option value="underline">Underscore (_)</option>
							<option value="double">Double underline(̲ )</option>
							<option value="box-empty">Empty box (☐)</option>
						</select>
						<div style="display:flex;align-items:center;gap:10px">
							<input type="checkbox" id="cursorBlinkChk" checked>
							<label for="cursorBlinkChk" class="field-label">Blink cursor</label>
						</div>
						<div style="font-size:12px;color:var(--muted)">
							Tip: Cursor uses text color (tab “Text Color”).
						</div>
					</div>
				</div>

				<!-- Hotkeys panel -->
				<div class="panel" id="hotkeysPanel">
					<label class="chip">Hotkeys / Controls</label>

					<div class="hotkey-list" style="margin-top:8px">
						<div class="hotkey-item">
							<span class="hotkey-key">F2</span>
							<span class="hotkey-desc">Toggle auto type</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">F4</span>
							<span class="hotkey-desc">Mute / Unmute sound</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">F6</span>
							<span class="hotkey-desc">Toggle generation</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">F7</span>
							<span class="hotkey-desc">Toggle fast typing mode</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">F8</span>
							<span class="hotkey-desc">Rewind (animated reset)</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">F9</span>
							<span class="hotkey-desc">Toggle clean mode (fullscreen coding)</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">F10</span>
							<span class="hotkey-desc">Toggle PC stats (clean mode only)</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">Backspace</span>
							<span class="hotkey-desc">Removes a character</span>
						</div>
						<div class="hotkey-item">
							<span class="hotkey-key">Esc</span>
							<span class="hotkey-desc">Clear screen / Exit clean mode</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		<footer class="site-footer">
			<div class="footer-content">
				<span>
					<a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" 
						style="color: inherit !important; text-decoration: none !important;" id="copyright-year">© </a>
					<a href="https://github.com/T0ls/typerScene---Cinematic"
						target="_blank" rel="noopener noreferrer" aria-label="Open GitHub repo: T0ls — TyperScene"
						style="color: inherit !important; text-decoration: none !important;">
						T0ls — TyperScene
					</a>
				</span>

				<a href="https://github.com/T0ls" target="_blank" rel="noopener noreferrer"
					class="gh-link" aria-label="GitHub: T0ls">
					<!-- GitHub mark (SVG inline) -->
					<svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
						<path d="M8 0C3.58 0 0 3.58 0 8a8 8 0 0 0 5.47 7.59c.4.07.55-.17.55-.38
							0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13
							-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52
							.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12
							0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82
							.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48
							0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8 8 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
					</svg>
					<span class="gh-username">@T0ls</span>
				</a>
			</div>
		</footer>


		<script>
// IIFE
(() => {
	const cleanBtn   = document.getElementById('cleanBtn');

	const screen = document.getElementById('screen');
	const fileInput = document.getElementById('fileInput');
	const source = document.getElementById('source');
	const chunkRange = document.getElementById('chunkRange');
	const chunkVal = document.getElementById('chunkVal');
	const generateChk = document.getElementById('generate');
	const modeSelect = document.getElementById('modeSelect');
	const clearBtn = document.getElementById('clearBtn');
	const restartBtn = document.getElementById('restartBtn');
	const copyBtn = document.getElementById('copyBtn');
	const preview = document.getElementById('preview');
	const cursor = document.getElementById('cursor');

	const fontSelect    = document.getElementById('fontSelect');
	const fontSizeRange = document.getElementById('fontSizeRange');
	const fontSizeVal   = document.getElementById('fontSizeVal');

	const rewindSpeedRange = document.getElementById('rewindSpeedRange');
	const rewindSpeedVal   = document.getElementById('rewindSpeedVal');

	let autoTyping = false;
	let autoTimer = null;

	// Interval between typing ticks in ms (adjust to taste).
	let autoIntervalMs = 40;

	let rawText = '';
	let ptr = 0;
	let fastMode = false;
	let cleanMode = false;

	// Stato extra
	let userLoadedFile = false;   // diventa true quando carichi un file
	let warnedGenWithFile = false; // per non ripetere alert
	let currentMode = 'py';       // py | rust | java | asm | sql

	let rewindAnimated = true;
	let rewindRAF = null; // requestAnimationFrame id

	let burstTimer = null;      // setInterval attivo durante il “micro-typing”
	let burstLeft  = 0;         // quanti caratteri mancano nel burst corrente
	let burstDelayMs = 12;   // ritardo tra un carattere e l’altro (default 12)

	// mappa select → linguaggio
	const modeMap = { py:'py', rust:'rust', java:'java', asm:'asm', sql:'sql' };

	const examples = {
		py: `import asyncio
import dataclasses
import hashlib
import json
import logging
import re
import sys
import time
from collections import deque
from dataclasses import dataclass, field
from typing import Deque, Dict, List, Set, Tuple

try:
import aiohttp
except ImportError:
aiohttp = None  # placeholder if the lib is missing

LOG = logging.getLogger("matrixcrawler")
logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s: %(message)s")

HREF_RE = re.compile(r'href=[](.*?)[]', re.I)

@dataclass
class Page:
url: str
code: int
title: str
links: List[str] = field(default_factory=list)
fingerprint: str = ""

@dataclass
class LRU:
maxsize: int
q: Deque[str] = field(default_factory=deque)
s: Set[str] = field(default_factory=set)

def add(self, item: str) -> None:
if item in self.s:
return
self.q.append(item)
self.s.add(item)
if len(self.q) > self.maxsize:
old = self.q.popleft()
self.s.remove(old)

def __contains__(self, item: str) -> bool:
return item in self.s

class RateLimiter:
def __init__(self, rate_per_sec: float = 4.0):
self.period = 1.0 / max(0.001, rate_per_sec)
self._last = 0.0

async def wait(self):
now = time.perf_counter()
dt = now - self._last
if dt < self.period:
await asyncio.sleep(self.period - dt)
self._last = time.perf_counter()

class Crawler:
def __init__(self, seed: str, limit: int = 50, rate: float = 4.0):
self.seed = seed
self.limit = limit
self.rate = RateLimiter(rate)
self.visited = LRU(512)
self.q: Deque[str] = deque([seed])
self.done = 0
self.index: Dict[str, Page] = {}

async def fetch(self, session, url: str) -> Tuple[int, str]:
await self.rate.wait()
try:
async with session.get(url, timeout=10) as resp:
txt = await resp.text(errors="ignore")
return resp.status, txt
except Exception as e:
LOG.warning("fetch error %s: %s", url, e)
return 0, ""

def parse(self, url: str, text: str) -> Page:
title_match = re.search(r"<title>(.*?)</title>", text, re.I | re.S)
title = (title_match.group(1).strip() if title_match else url)[:120]
links = re.findall(r'href=[](.*?)[]', text, flags=re.I)
links = [l for l in links if l.startswith("http")]
fp = hashlib.sha1(text[:5000].encode("utf-8", "ignore")).hexdigest()
return Page(url=url, code=200 if text else 0, title=title, links=links[:50], fingerprint=fp)

async def run(self) -> None:
if aiohttp is None:
LOG.error("aiohttp not installed — demo will skip network")
for i in range(min(10, self.limit)):
fake = f"https://example.org/{i}"
p = self.parse(fake, f"<html><title>Example {i}</title><a href='https://example.org/{i+1}'>n</a></html>")
self.index[p.url] = p
return

async with aiohttp.ClientSession(headers={"User-Agent": "MatrixCrawler/1.0"}) as session:
while self.q and self.done < self.limit:
url = self.q.popleft()
if url in self.visited:
continue
self.visited.add(url)
code, txt = await self.fetch(session, url)
page = self.parse(url, txt)
page.code = code
self.index[url] = page
self.done += 1
LOG.info("done=%s url=%s title=%s", self.done, url, page.title)
for l in page.links:
if l not in self.visited and len(self.q) < self.limit * 2:
self.q.append(l)

def to_json(self) -> str:
return json.dumps({k: dataclasses.asdict(v) for k, v in self.index.items()}, indent=2)

async def amain(seed: str, limit: int):
crawler = Crawler(seed, limit=limit, rate=4.0)
await crawler.run()
print(crawler.to_json())

def main(argv):
import argparse
p = argparse.ArgumentParser()
p.add_argument("--seed", default="https://example.org")
p.add_argument("--max-pages", type=int, default=40)
a = p.parse_args(argv)
asyncio.run(amain(a.seed, a.max_pages))
return 0

if __name__ == "__main__":
raise SystemExit(main(sys.argv[1:]))
`,
		rust: `use std::{collections::VecDeque, time::Duration};
use clap::Parser;
use tokio::{fs::File, io::{AsyncBufReadExt, BufReader}, time::sleep};
use serde::Serialize;

#[derive(Parser, Debug)]
#[command(name = "logtail", version, about = "Async log monitor")]
struct Args{
/// Path to the log file
#[arg(short, long)]
file: String,
/// Max buffered lines
#[arg(long, default_value_t = 200)]
max: usize,
}

#[derive(Debug, Serialize)]
struct Line{
idx: usize,
level: String,
text: String,
}

fn classify(s: &str) -> String{
if s.contains("ERROR"){ "ERROR".into() }
else if s.contains("WARN"){ "WARN".into() }
else if s.contains("DEBUG"){ "DEBUG".into() }
else { "INFO".into() }
}

#[tokio::main]
async fn main(){
let args = Args::parse();
let path = args.file;
let mut buf: VecDeque<Line> = VecDeque::new();
let mut idx: usize = 0;

loop {
match File::open(&path).await {
Ok(f) => {
let reader = BufReader::new(f);
let mut lines = reader.lines();
while let Ok(Some(l)) = lines.try_next_line().await {
let level = classify(&l);
let line = Line{ idx, level, text: l };
if buf.len() >= args.max { buf.pop_front(); }
buf.push_back(line);
idx += 1;
}
// fake render
println!("--- last {} lines ---", buf.len());
for ln in buf.iter().rev().take(15){
println!("[{:05}] {:<5} {}", ln.idx, ln.level, ln.text);
}
}
Err(e) => {
eprintln!("open error: {e}");
}
}
sleep(Duration::from_millis(600)).await;
}
}
`,
		java: `import java.io.Closeable;
import java.time.Instant;
import java.util.*;
import java.util.concurrent.*;

public final class MiniScheduler implements Closeable {
private final ScheduledExecutorService exec = Executors.newScheduledThreadPool(2);
private final Map<String, ScheduledFuture<?>> tasks = new ConcurrentHashMap<>();

public interface Job { void run() throws Exception; }

public String every(String name, long periodMs, Job job){
ScheduledFuture<?> f = exec.scheduleAtFixedRate(() -> {
try{
System.out.printf("%s RUN %s%n", Instant.now(), name);
job.run();
}catch(Exception e){
System.err.printf("%s ERR %s: %s%n", Instant.now(), name, e.getMessage());
}
}, periodMs, periodMs, TimeUnit.MILLISECONDS);
tasks.put(name, f);
return name;
}

public void cancel(String name){
ScheduledFuture<?> f = tasks.remove(name);
if (f != null) f.cancel(false);
}

@Override public void close(){
exec.shutdown();
}

// Demo
public static void main(String[] args) throws Exception {
try (MiniScheduler s = new MiniScheduler()){
s.every("heartbeat", 700, () -> System.out.println("tick"));
s.every("work", 1200, () -> {
Thread.sleep(100);
System.out.println("work done");
});
Thread.sleep(6000);
}
}
}
`,
		sql: `DROP TABLE IF EXISTS orders_items;
DROP TABLE IF EXISTS orders;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS customers;
DROP SCHEMA IF EXISTS audit CASCADE;

CREATE TABLE customers (
id           SERIAL PRIMARY KEY,
created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
email        TEXT NOT NULL UNIQUE,
full_name    TEXT NOT NULL,
country      TEXT NOT NULL,
is_vip       BOOLEAN NOT NULL DEFAULT FALSE
);

CREATE TABLE products (
id           SERIAL PRIMARY KEY,
sku          TEXT NOT NULL UNIQUE,
name         TEXT NOT NULL,
unit_price   NUMERIC(12,2) NOT NULL CHECK (unit_price >= 0),
category     TEXT NOT NULL
);

CREATE TABLE orders (
id           BIGSERIAL PRIMARY KEY,
created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
customer_id  INT NOT NULL REFERENCES customers(id),
currency     TEXT NOT NULL DEFAULT 'USD',
status       TEXT NOT NULL CHECK (status IN ('NEW','PAID','SHIPPED','CANCELLED'))
);

CREATE TABLE orders_items (
order_id     BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
product_id   INT NOT NULL REFERENCES products(id),
qty          INT NOT NULL CHECK (qty > 0),
unit_price   NUMERIC(12,2) NOT NULL CHECK (unit_price >= 0),
PRIMARY KEY (order_id, product_id)
);

-- 2) Indexes
CREATE INDEX IF NOT EXISTS idx_orders_customer ON orders(customer_id);
CREATE INDEX IF NOT EXISTS idx_orders_created   ON orders(created_at);
CREATE INDEX IF NOT EXISTS idx_items_product    ON orders_items(product_id);

-- 3) Sample data
INSERT INTO customers(email, full_name, country, is_vip) VALUES
('neo@example.com','Neo Anderson','US', true),
('trinity@example.com','Trinity','US', true),
('morpheus@example.com','Morpheus','US', true),
('smith@example.com','Agent Smith','US', false),
('ora@example.com','The Oracle','GR', true),
('mouse@example.com','Mouse','US', false),
('tank@example.com','Tank','US', false),
('dozer@example.com','Dozer','US', false);

INSERT INTO products(sku, name, unit_price, category) VALUES
('KB-001','Mechanical Keyboard', 129.90, 'Peripherals'),
('MS-010','Optical Mouse',        39.50, 'Peripherals'),
('MN-404','27 inch Monitor',     249.00, 'Displays'),
('HD-900','External SSD 2TB',    219.99, 'Storage'),
('CM-777','USB-C Cable',           9.99, 'Cables'),
('HS-110','Headset',              69.99, 'Audio');

-- Orders
INSERT INTO orders(customer_id, currency, status, created_at) VALUES
(1,'USD','PAID',      now() - interval '3 days'),
(2,'USD','PAID',      now() - interval '2 days'),
(3,'USD','SHIPPED',   now() - interval '1 day'),
(1,'USD','CANCELLED', now() - interval '18 hours'),
(4,'USD','NEW',       now() - interval '2 hours');

-- Items
INSERT INTO orders_items(order_id, product_id, qty, unit_price) VALUES
(1,1,1,129.90),(1,2,2,39.50),
(2,3,1,249.00),(2,6,1,69.99),
(3,4,1,219.99),(3,5,3,9.99),
(4,6,2,69.99),
(5,5,5,9.99);

-- 4) Computed totals view
CREATE OR REPLACE VIEW v_order_totals AS
SELECT
o.id AS order_id,
o.customer_id,
o.status,
o.created_at,
SUM(oi.qty * oi.unit_price) AS subtotal,
CASE WHEN c.is_vip THEN 0.9 ELSE 1.0 END AS vip_multiplier,
ROUND(SUM(oi.qty * oi.unit_price) * (CASE WHEN c.is_vip THEN 0.9 ELSE 1.0 END), 2) AS total_after_vip
FROM orders o
JOIN orders_items oi ON oi.order_id = o.id
JOIN customers c ON c.id = o.customer_id
GROUP BY o.id, o.customer_id, o.status, o.created_at, c.is_vip;

-- 5) Window functions — RFM-ish scoring
WITH spend AS (
SELECT customer_id, SUM(total_after_vip) AS spent
FROM v_order_totals
WHERE status IN ('PAID','SHIPPED')
GROUP BY customer_id
),
freq AS (
SELECT customer_id, COUNT(*) AS orders_count
FROM orders
WHERE status IN ('PAID','SHIPPED')
GROUP BY customer_id
),
recency AS (
SELECT customer_id, MIN(EXTRACT(EPOCH FROM (now() - created_at))/86400)::int AS days_since_first
FROM orders
WHERE status IN ('PAID','SHIPPED')
GROUP BY customer_id
)
SELECT
c.id, c.full_name,
COALESCE(s.spent,0) AS spent,
COALESCE(f.orders_count,0) AS orders_count,
COALESCE(r.days_since_first,9999) AS days_since_first,
NTILE(5) OVER (ORDER BY COALESCE(s.spent,0))          AS spend_tile,
NTILE(5) OVER (ORDER BY COALESCE(f.orders_count,0))   AS freq_tile,
NTILE(5) OVER (ORDER BY -COALESCE(r.days_since_first,9999)) AS recency_tile
FROM customers c
LEFT JOIN spend s ON s.customer_id = c.id
LEFT JOIN freq  f ON f.customer_id = c.id
LEFT JOIN recency r ON r.customer_id = c.id
ORDER BY spent DESC, orders_count DESC, c.id;

-- 6) CTE with rollups
WITH per_cat AS (
SELECT p.category, SUM(oi.qty * oi.unit_price) AS revenue
FROM orders_items oi JOIN products p ON p.id = oi.product_id
GROUP BY 1
)
SELECT category, revenue, ROUND(100*revenue/SUM(revenue) OVER (),2) AS pct
FROM per_cat
ORDER BY revenue DESC;

-- 7) Audit schema: trigger example
CREATE SCHEMA IF NOT EXISTS audit;

CREATE TABLE audit.order_changes (
id BIGSERIAL PRIMARY KEY,
ts TIMESTAMPTZ NOT NULL DEFAULT now(),
order_id BIGINT NOT NULL,
old_status TEXT,
new_status TEXT
);

CREATE OR REPLACE FUNCTION audit.fn_order_status() RETURNS trigger AS $$
BEGIN
IF TG_OP = 'UPDATE' AND NEW.status IS DISTINCT FROM OLD.status THEN
INSERT INTO audit.order_changes(order_id, old_status, new_status)
VALUES (NEW.id, OLD.status, NEW.status);
END IF;
RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_order_status ON orders;
CREATE TRIGGER trg_order_status
AFTER UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION audit.fn_order_status();

-- 8) Example updates to fire the trigger
UPDATE orders SET status='PAID' WHERE status='NEW';
UPDATE orders SET status='SHIPPED' WHERE status='PAID';

-- 9) Show audit
SELECT * FROM audit.order_changes ORDER BY ts DESC;

-- 10) Parameterized report (simulated with CTE vars)
WITH params AS (SELECT 'US'::text AS country_filter)
SELECT o.id, c.full_name, v.subtotal, v.total_after_vip, o.status
FROM orders o
JOIN v_order_totals v ON v.order_id = o.id
JOIN customers c ON c.id = o.customer_id
JOIN params p ON p.country_filter = c.country
ORDER BY o.created_at DESC;
`,
		asm: `BITS 64
GLOBAL _start

section .data
banner:     db  0x1b,"[32m== MATRIX ==[0m",10
banner_len: equ $-banner

prompt:     db  "Input: ",0
prompt_len: equ $-prompt

buf:        times 256 db 0

section .text
_start:
; write banner
mov rax,1           ; sys_write
mov rdi,1
mov rsi,banner
mov rdx,banner_len
syscall

; write prompt
mov rax,1
mov rdi,1
mov rsi,prompt
mov rdx,prompt_len
syscall

; read into buf
mov rax,0           ; sys_read
mov rdi,0
mov rsi,buf
mov rdx,256
syscall             ; RAX = count

; RAX contains count, set RCX = count-1 (ignore newline)
mov rcx, rax
dec rcx

; Reverse in-place
xor r8, r8          ; i = 0
mov r9, rcx         ; j = n-1
.rev_loop:
cmp r8, r9
jge .rev_done
mov al, [buf + r8]
mov bl, [buf + r9]
mov [buf + r8], bl
mov [buf + r9], al
inc r8
dec r9
jmp .rev_loop
.rev_done:

; write result
mov rax,1
mov rdi,1
mov rsi,buf
mov rdx,rcx
syscall

; exit(0)
mov rax,60
xor rdi, rdi
syscall
`,
	};

	// === Reset UI ai default quando ricarichi la pagina  ===
	function resetUIToDefaultsOnLoad(){
		// dropdown / checkbox ai default
		modeSelect && (modeSelect.selectedIndex = 0);
		fontSelect  && (fontSelect.selectedIndex  = 0);
		const cursorSelect = document.getElementById('cursorSelect');
		cursorSelect && (cursorSelect.value = 'default');
		typeof setCursorStyle === 'function' && setCursorStyle('default');

		generateChk && (generateChk.checked = false);

		// scanlines & vignette
		document.getElementById('bgScanlinesChk').checked = false;
		document.getElementById('bgVignetteChk').checked = false;

		// mono color off
		const monoColorChk = document.getElementById('monoColor');
		const preview = document.querySelector('.preview');
		if (monoColorChk){ monoColorChk.checked = false; }
		preview && preview.classList.remove('mono');

		// range: ripristina al valore di default e notifica i listener "input"
		const fireInput = el => el && el.dispatchEvent(new Event('input', { bubbles:true }));
		if (chunkRange){
			chunkRange.value = chunkRange.getAttribute('value') || '1';
			fireInput(chunkRange);
		}
		const rewindSpeedRange = document.getElementById('rewindSpeedRange');
		if (rewindSpeedRange){
			rewindSpeedRange.value = rewindSpeedRange.getAttribute('value') || '5';
			fireInput(rewindSpeedRange);
		}
		const fontSizeRange = document.getElementById('fontSizeRange');
		if (fontSizeRange){
			fontSizeRange.value = fontSizeRange.getAttribute('value') || '18';
			fireInput(fontSizeRange);
		}
		const volumeRange = document.getElementById('volumeRange');
		if (volumeRange){
			volumeRange.value = volumeRange.getAttribute('value') || '50';
			fireInput(volumeRange);
		}
		const colorHexInput = document.getElementById('colorHexInput');
		colorHexInput.value = "";

		// audio: torna al click generato
		const soundFileInput = document.getElementById('soundFileInput');
		const soundFileLabel = document.getElementById('soundFileLabel');
		if (typeof useCustomSound !== 'undefined') useCustomSound = false;
		if (typeof customSoundBuffer !== 'undefined') customSoundBuffer = null;
		soundFileInput && (soundFileInput.value = '');
		soundFileLabel && (soundFileLabel.textContent = 'Default click');

		// bottone mute ON (cioè audio attivo)
		const toggleSoundBtn = document.getElementById('toggleSoundBtn');
		if (typeof soundMuted !== 'undefined') soundMuted = false;
		if (toggleSoundBtn){ toggleSoundBtn.textContent = '🔊 Sound On'; toggleSoundBtn.style.opacity = 1; }

		// sorgente / preview vuoti e cursore all’inizio
		const fileInput = document.getElementById('fileInput');
		const source = document.getElementById('source');
		fileInput && (fileInput.value = '');
		if (typeof rawText !== 'undefined') rawText = '';
		if (typeof ptr !== 'undefined') ptr = 0;
		const screen = document.getElementById('screen');
		screen && (screen.innerHTML = '');
		source && (source.value = '');
		const cursor = document.getElementById('cursor');
		if (cursor){ cursor.style.top = '0px'; cursor.style.left = '0px'; }

		// sync UI vario
		typeof updateCleanBtn === 'function' && updateCleanBtn();
		(typeof scheduleRender === 'function' ? scheduleRender : (typeof render==='function'&&render))?.();
	}

	// pageshow copre anche i casi di back/forward cache oltre al normale load
	window.addEventListener('pageshow', resetUIToDefaultsOnLoad);

	// Ricalcola posizione cursore dopo cambi layout/font/fullscreen
	function resyncCursorAfterLayout(){
		// doppio rAF per aspettare il reflow
		requestAnimationFrame(()=> {
			(typeof scheduleRender === 'function' ? scheduleRender : (typeof render==='function'&&render))?.();
			setTimeout(()=> (typeof scheduleRender === 'function' ? scheduleRender : (typeof render==='function'&&render))?.(), 30);
		});
	}


	// === Cursor Style ===
	const cursorSelect = document.getElementById('cursorSelect');

	function setCursorStyle(style){
		if (!cursor) return;
		const variants = ['cursor--bar','cursor--vintage','cursor--underline','cursor--double','cursor--box','cursor--box-empty'];
		cursor.classList.remove(...variants);
		if (style && style !== 'default') {
			cursor.classList.add('cursor--' + style);
		}
		// se il tipo cambia (es. bar -> box), un render aiuta a riallineare
		if (typeof render === 'function') render();
	}

	cursorSelect?.addEventListener('change', () => {
		setCursorStyle(cursorSelect.value);
	});

	// inizializza il valore del select in base allo stato attuale (non forziamo un default)
	(function initCursorSelect(){
		if (!cursorSelect || !cursor) return;
		const existing = [...cursor.classList].find(c => c.startsWith('cursor--'));
		cursorSelect.value = existing ? existing.replace('cursor--','') : 'default';
	})();

	const cursorBlinkChk = document.getElementById('cursorBlinkChk');

	// inizializza lo stato in base alla classe presente (di default: lampeggia)
	if (cursorBlinkChk) {
		cursorBlinkChk.checked = !cursor.classList.contains('no-blink');
		cursorBlinkChk.addEventListener('change', () => {
			if (!cursor) return;
			cursor.classList.toggle('no-blink', !cursorBlinkChk.checked);
			// piccolo re-render per riallineare eventuale stile
			if (typeof render === 'function') render();
		});
	}

	// Load default code
	function loadExample(mode){
		rawText = examples[mode] || examples.py;
		source.value = rawText;
		ptr = 0;
		render();
	}

	function startAutoTyping() {
		if (autoTyping) return;
		autoTyping = true;
		if (!rawText) loadExample(modeSelect.value);

		autoTimer = setInterval(() => {
			// Stop if we reached the end
			if (ptr >= rawText.length) {
				stopAutoTyping();
				return;
			}

			// Type the next chunk; uses current `speed`
			const ev = new KeyboardEvent('keydown', {
				key: 'l',
				code: 'KeyL',
				keyCode: 18,    // legacy, ma utile per compatibilità
				which: 18,      // legacy
				bubbles: true,
			});
			type(ev);

			// Safety: if we just finished, stop.
			if (ptr >= rawText.length) {
				stopAutoTyping();
			}
		}, autoIntervalMs);
	}

	function stopAutoTyping() {
		if (!autoTyping) return;
		autoTyping = false;
		if (autoTimer) {
			clearInterval(autoTimer);
			autoTimer = null;
		}
	}

	function toggleAutoTyping() {
		if (autoTyping) stopAutoTyping();
			else startAutoTyping();
	}

	/* =========================
	Syntax Highlighter v2
	Support: python, rust, java, sql, asm (x86)
	Fallback: generic
	========================= */

	function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

	// Costruisce liste -> pattern \b(?:A|B|C)\b
	function wordsRE(words){
		// Escape any regex meta in words (safe even if not needed)
		const escaped = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
		// IMPORTANT: join with '|' (NOT '\|')
		return `\\b(?:${escaped.join('|')})\\b`;
	}

	function normLang(l){
		const s = (l||'').toLowerCase();
		if (s === 'py' || s === 'python') return 'python';
		if (s === 'rs' || s === 'rust')   return 'rust';
		if (s === 'asm' || s.includes('x86')) return 'asm';
		return s; // 'java', 'sql', 'generic', etc.
	}

	// Lexer per-lingua (pattern nominati). Ordine: string|comment -> specifici -> numeri/fn/kw/type -> punct
	function buildLexer(cfg){
		const lang = normLang(cfg.lang);
		// Common fragments`
		const pyPrefix = `(?:[rR]|[fF]|[bB]|[rR][fF]|[fF][rR]|[rR][bB]|[bB][rR])?`;
		const strGeneric   = `(?<str>"(?:\\\\.|[^"\\\\])*"|'(?:\\\\.|[^'\\\\])*')`;
		const mlCommentC   = `(?<comment>/\\*[\\s\\S]*?\\*/)`;
		const slCommentC   = `(?<comment>//[^\\n]*)`;
		const slCommentHash= `(?<comment>#[^\\n]*)`;
		const slCommentSQL = `(?<comment>--[^\\n]*)`;
		const number       = `(?<num>\\b0x[\\da-fA-F]+\\b|\\b\\d+(?:\\.\\d+)?\\b)`;
		const punct 	   = `(?<punct>[{}()\\[\\];.,:+\\-/*%<>=!?&|^~])`;
		const fnCall       = `(?<fn>[A-Za-z_][A-Za-z0-9_]*)(?=\\s*\\()`;

		if (lang === 'python'){
			const kw = wordsRE([
				'def','class','return','if','elif','else','for','while','import','from','as','with','try','except','finally',
				'raise','pass','lambda','yield','del','global','nonlocal','assert','async','await','in','is','and','or','not'
			]);
			const type = wordsRE(['int','float','bool','str','list','tuple','dict','set','None','True','False','bytes','range','object']);

			// accept r/f/b and combos (rf, fr, rb, br)
			const triplePy     = `(?<str>${pyPrefix}(?:'''[\\s\\S]*?'''|"""[\\s\\S]*?"""))`;
			const strGenericPy = `(?<str>${pyPrefix}(?:"(?:\\\\.|[^"\\\\])*"|'(?:\\\\.|[^'\\\\])*'))`;

			// Python: case-sensitive → 'gm'
			return new RegExp(
				[triplePy, strGenericPy, slCommentHash, number, `(?<kw>${kw})`, `(?<type>${type})`, fnCall, punct].join('|'),
				'gm'
			);
		}


		if (lang === 'rust'){
			const kw = wordsRE([
				'fn','let','mut','pub','crate','mod','use','impl','trait','struct','enum','match','if','else','loop','while','for',
				'return','move','ref','self','super','dyn','unsafe','async','await','where','const','static'
			]);
			const type = wordsRE([
				'u8','u16','u32','u64','u128','i8','i16','i32','i64','i128','usize','isize','bool','char','str','String','Vec',
				'Option','Result','Box','Rc','Arc','Self'
			]);
			const rustRaw  = `(?<str>r(#{0,5})"(?:[\\s\\S]*?)"\\2)`; // r"..." / r#"..."
			const lifetime = `(?<type>'[A-Za-z_][A-Za-z0-9_]*)`;
			const macroId  = `(?<kw>[a-z_][a-z0-9_]*)(?=!)`;
			// Rust: case-sensitive → 'gm'
			return new RegExp([rustRaw, strGeneric, mlCommentC, slCommentC, lifetime, number, macroId, `(?<kw>${kw})`, `(?<type>${type})`, fnCall, punct].join('|'), 'gm');
		}

		if (lang === 'java'){
			const kw = wordsRE([
				'public','private','protected','class','interface','enum','extends','implements','package','import','new','return',
				'if','else','for','while','do','switch','case','break','continue','try','catch','finally','throw','throws',
				'this','super','static','final','abstract','volatile','transient','synchronized','instanceof'
			]);
			const type = wordsRE([
				'void','int','long','double','float','boolean','char','byte','short','String','List','Map','Set','ArrayList','HashMap'
			]);
			// Java: case-sensitive → 'gm'
			return new RegExp([strGeneric, mlCommentC, slCommentC, number, `(?<kw>${kw})`, `(?<type>${type})`, fnCall, punct].join('|'), 'gm');
		}

		if (lang === 'sql'){
			const kw = wordsRE([
				'SELECT','FROM','WHERE','INSERT','INTO','VALUES','UPDATE','SET','DELETE','CREATE','TABLE','PRIMARY','KEY','FOREIGN',
				'NOT','NULL','JOIN','LEFT','RIGHT','INNER','OUTER','ON','AND','OR','ORDER','BY','GROUP','HAVING','LIMIT','OFFSET',
				'AS','DISTINCT','UNION','ALL','ALTER','ADD','DROP','INDEX'
			]);
			const type = wordsRE([
				'INT','INTEGER','SERIAL','BIGINT','SMALLINT','DECIMAL','NUMERIC','REAL','DOUBLE','PRECISION','BOOLEAN','TEXT','VARCHAR',
				'CHAR','DATE','TIMESTAMP','TIME','JSON','UUID'
			]);
			const strSQL = `(?<str>'(?:''|[^'])*')`;
			// SQL: case-insensitive → 'gmi'
			return new RegExp([strSQL, strGeneric, mlCommentC, slCommentSQL, number, `(?<kw>${kw})`, `(?<type>${type})`, fnCall, punct].join('|'), 'gmi');
		}

		if (lang === 'asm'){ // x86
			const kw = wordsRE([
				'mov','lea','push','pop','call','ret','jmp','je','jne','jg','jl','jge','jle','cmp','test',
				'add','sub','mul','imul','div','idiv','and','or','xor','shl','shr','inc','dec','nop',
				'int','sysenter','syscall'
			]);
			const regs   = `(?<type>\\b(?:[re]?(?:ax|bx|cx|dx|si|di|sp|bp)|r1[0-5]|r[8-9]|[xy]mm\\d+)\\b)`;
			const label  = `(?<fn>^[A-Za-z_][A-Za-z0-9_]*)(?=:)`;
			const slAsm  = `(?<comment>;[^\\n]*)`;
			// ASM: case-sensitive → 'gm'
			return new RegExp([strGeneric, slAsm, regs, number, label, `(?<kw>${kw})`, fnCall, punct].join('|'), 'gm');
		}

		// Fallback: case-sensitive
		return new RegExp([strGeneric, mlCommentC, slCommentC, slCommentHash, slCommentSQL, number, fnCall, punct].join('|'), 'gm');
	}

	function highlight(text, lang){
		const re = buildLexer({ lang });   // MUST have 'g' flag
		re.lastIndex = 0;                  // reset state
		console.log("TEXT:",text)

		let out = '';
		let lastIndex = 0;
		let m;

		while ((m = re.exec(text)) !== null) {
			const groups = m.groups || {};
			const start  = m.index;          // <-- reliable offset
			const end    = re.lastIndex;     // end of match (with 'g')

			// plain chunk before the match
			out += esc(text.slice(lastIndex, start));

			// decide CSS class
			let cls = null;
			if (groups.comment) cls = 'comment';
				else if (groups.str)  cls = 'str';
					else if (groups.type) cls = 'type';
						else if (groups.kw)   cls = 'kw';
							else if (groups.fn)   cls = 'fn';
								else if (groups.num)  cls = 'num';
									else if (groups.punct)cls = 'punct';

			// emit token
			const token = m[0];
			out += cls ? `<span class="${cls}">${esc(token)}</span>` : esc(token);

			lastIndex = end;
		}

		console.log(out)
		// trailing plain text
		out += esc(text.slice(lastIndex));
		return out;
	}

	// === Render incrementale + rAF ===
	let lastRenderedPtr = 0;   // quanto è già stato “dipinto”
	let renderRAF = 0;

	function getLang(){
		// aggiorna l’ID qui sotto con quello reale del tuo select della lingua
		const v = (document.getElementById('modeSelect')?.value || '').toLowerCase();
		if (v.includes('py')) return 'py';
		if (v.includes('rust'))   return 'rust';
		if (v.includes('java'))   return 'java';
		if (v.includes('sql'))    return 'sql';
		if (v.includes('asm') || v.includes('x86')) return 'asm';
		return 'generic';
	}

	// --- helper: choose a safe start for tail repaint ---
	function isBoundary(ch){ return /\s|[.,;:(){}\[\]]/.test(ch); }

	function findSafeStart(text, fromIndex){
		// repaint window to keep context (newline > other boundaries > hard cap)
		const MAX_LOOKBACK = 1024; // tune if you have huge lines/comments
		const floor = Math.max(0, fromIndex - MAX_LOOKBACK);

		// 1) prefer last newline within the window
		const nl = text.lastIndexOf('\n', fromIndex - 1);
		if (nl >= floor) return nl + 1;

		// 2) else last boundary like space/punct
		for (let j = fromIndex - 1; j >= floor; j--){
			if (isBoundary(text[j])) return j + 1;
		}
		// 3) fallback: repaint from the floor
		return floor;
	}

	function render(force = false){
		if (!force && renderRAF) return;
		if (force) { 
			flushRender(); 
			return; 
		}
		renderRAF = requestAnimationFrame(flushRender);
	}

	function flushRender(){
		renderRAF = 0;
		const lang = getLang();

		// full rebuild if rewound/cleared
		if (ptr < lastRenderedPtr || lastRenderedPtr === 0 || screen.innerHTML === '') {
			screen.innerHTML = highlight(rawText.slice(0, ptr), lang);
			lastRenderedPtr = ptr;
		} else {
			// repaint only the tail, but starting from a safe boundary behind lastRenderedPtr
			const safeStart = findSafeStart(rawText, lastRenderedPtr);
			const headHTML  = highlight(rawText.slice(0, safeStart), lang);
			const tailHTML  = highlight(rawText.slice(safeStart, ptr), lang);
			// simple & safe: rebuild innerHTML once (fast enough for typical sizes)
			screen.innerHTML = headHTML + tailHTML;
			lastRenderedPtr = ptr;
		}

		// keep your cursor anchor + auto-scroll logic
		let anchor = document.getElementById('cursorAnchor');
		if (anchor) anchor.remove();
		anchor = document.createElement('span');
		anchor.id = 'cursorAnchor';
		anchor.style.display = 'inline';
		anchor.style.width = '0';
		anchor.style.height = '0';
		screen.appendChild(anchor);

		const wrap = screen.parentElement;
		wrap.scrollTop = wrap.scrollHeight;

		const wrapRect = wrap.getBoundingClientRect();
		const aRect = anchor.getBoundingClientRect();
		const x = (aRect.left - wrapRect.left) + wrap.scrollLeft;
		const y = (aRect.top  - wrapRect.top)  + wrap.scrollTop;
		cursor.style.left = Math.max(0, x) + 'px';
		cursor.style.top  = Math.max(0, y) + 'px';

		const lh = parseFloat(getComputedStyle(screen).lineHeight) || 20;
		document.querySelector('.left')?.style.setProperty('--lh', lh + 'px');
	}

	modeSelect?.addEventListener('change', () => {
		lastRenderedPtr = 0;       // forzi ricostruzione completa
		render(true);              // flush immediato
	});

	generateChk?.addEventListener('change', () => {
		if (generateChk.checked && userLoadedFile) {
			alert('Generation is disabled because a file is loaded. Press ESC to clear the file and enable generation.');
			generateChk.checked = false;
		}
	});

	// file load
	fileInput.addEventListener('change', (e) => {
		const f = e.target.files?.[0];
		if (!f) return;
		userLoadedFile = true;
		warnedGenWithFile = false;
		const r = new FileReader();
		r.onload = () => {
			rawText = String(r.result);
			source.value = rawText;
			ptr = 0;
			render();
		};
		r.readAsText(f);
	});

	source.addEventListener('input', () => {
		rawText = source.value;
		ptr = 0;
		screen.innerHTML = '';
		render();
	});

	chunkRange.addEventListener('input', () => {
		chunkVal.textContent = chunkRange.value;
	});

	modeSelect.addEventListener('change', () => {
		currentMode = modeMap[modeSelect.value];
		const val = modeSelect.value;
		if (!generateChk.checked) loadExample(val);
	});

	const rewindAnimChk = document.getElementById('rewindAnimChk');
	rewindAnimChk?.addEventListener('change', () => {
		rewindAnimated = rewindAnimChk.checked;
		// se sto animando e l’utente disattiva ora l’animazione → stop immediato
		if (!rewindAnimated && rewindRAF) { cancelAnimationFrame(rewindRAF); rewindRAF = null; }
	});

	const burstDelayRange = document.getElementById('burstDelayRange');
	const burstDelayVal   = document.getElementById('burstDelayVal');

	if (burstDelayRange && burstDelayVal){
		// init UI dallo stato
		burstDelayRange.value = String(burstDelayMs);
		burstDelayVal.textContent = `${burstDelayMs}ms`;

		burstDelayRange.addEventListener('input', () => {
			burstDelayMs = parseInt(burstDelayRange.value, 10) || 12;
			burstDelayVal.textContent = `${burstDelayMs}ms`;
			// Applica subito: interrompi un burst in corso (se presente)
			if (burstTimer){ clearInterval(burstTimer); burstTimer = null; }
		});
	}

	clearBtn.addEventListener('click', () => {
		userLoadedFile = false;
		warnedGenWithFile = false;
		rawText = '';
		ptr = 0;
		screen.innerHTML = '';
		source.value = '';
	});

	// Rewind animato (riporta il cursore in alto a sinistra alla fine)
	function getRewindStep(){
		// usa il tuo slider di velocità, con fallback
		const v = parseInt(document.getElementById('rewindSpeedRange')?.value || '40', 10);
		return Math.max(1, v);
	}

	function rewindToStart(){
		// interrompi eventuale animazione precedente
		if (rewindRAF) { cancelAnimationFrame(rewindRAF); rewindRAF = null; }

		if (!rewindAnimated){
			ptr = 0;
			render(); // il tuo render già ricolloca il cursore e scrolla
			return;
		}

		const step = getRewindStep();
		const tick = () => {
			if (ptr <= 0){
				ptr = 0;
				render();
				rewindRAF = null;
				return;
			}
			ptr = Math.max(0, ptr - step);
			render();
			rewindRAF = requestAnimationFrame(tick);
		};
		tick();
	}

	// collega il bottone alla nuova funzione
	restartBtn?.addEventListener('click', rewindToStart);


	copyBtn.addEventListener('click', () => {
		navigator.clipboard.writeText(rawText.slice(0, ptr) || '').then(()=>{
			alert('Copied to clipboard');
		}).catch(()=>alert('Copy error'));
	});

	// generator
	function randomIdentifier(len){
		const chars = 'abcdefghijklmnopqrstuvwxyz';
		let s = '';
		for (let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
		return s;
	}

	// Helpers
	function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
	function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
	function ident(len=randInt(4,9)){ const a='abcdefghijklmnopqrstuvwxyz'; return Array.from({length:len},()=>a[randInt(0,a.length-1)]).join(''); }
	const IND = (n)=>' '.repeat(n);

	// Genera blocchi multi-riga non banali, con indentazione
	function generateSnippet(lang='py'){
		if (userLoadedFile) {
			if (!warnedGenWithFile) {
				alert('Generation is disabled because a file is loaded. Clear the file to enable generation.');
				warnedGenWithFile = true;
			}
			return ''; // skip
		}

		switch(lang){
			case 'py':   return genPy();
			case 'rust': return genRust();
			case 'java': return genJava();
			case 'asm':  return genAsm();
			case 'sql':  return genSql();
			default:     return genPy();
		}
	}

	function maybeGenerateNextBlock(){
		if (!generateChk.checked) return;      // generazione disattivata → stop
		if (userLoadedFile) return;            // file utente presente → stop (alert già mostrato)
		// siamo a fine testo: appendo un nuovo blocco del linguaggio corrente
		const snippet = generateSnippet(currentMode);
		if (!snippet) return;
		// separatore elegante
		rawText += (rawText.endsWith('\n') ? '' : '\n') + `\n` + snippet;
		source.value = rawText;                // tieni in sync la source textarea
		// NON avanzare ptr qui: il prossimo tasto “consuma” il nuovo blocco
	}


	// se abbiamo finito ciò che c'era, valuta se generare
	if (ptr === rawText.length) {
		maybeGenerateNextBlock();
	}

	// ---- PYTHON ----
	function genPy(){
		const fn = ident(), it = ident(), coll = ident(), ctx = ident();
		const blockA = [
			`@dataclass`,
			`class ${ident(1).toUpperCase()+ident(5)}:`,
			`${IND(4)}id: int`,
			`${IND(4)}name: str`,
			`${IND(4)}score: float = 0.0`,
			``,
			`def ${fn}(${coll}: list[int]) -> dict[str,int]:`,
			`${IND(4)}acc: dict[str,int] = {}`,
			`${IND(4)}for ${it} in ${coll}:`,
			`${IND(8)}k = f"key-{${it}%5}"`,
			`${IND(8)}acc[k] = acc.get(k, 0) + 1`,
			`${IND(4)}return acc`,
			``,
			`async def ${ident()}(${ctx}: asyncio.AbstractEventLoop) -> list[str]:`,
			`${IND(4)}async def work(i:int) -> str:`,
			`${IND(8)}await asyncio.sleep(0.01)`,
			`${IND(8)}return f"done-{i}"`,
			`${IND(4)}tasks = [${ctx}.create_task(work(i)) for i in range(${randInt(8,18)})]`,
			`${IND(4)}return await asyncio.gather(*tasks)`,
		];
		const blockB = [
			`class ${ident(1).toUpperCase()+ident(6)}:`,
			`${IND(4)}def __init__(self, size:int=128):`,
			`${IND(8)}self.size=size; self.q: list[str] = []`,
			`${IND(4)}def push(self, x:str):`,
			`${IND(8)}self.q.append(x)`,
			`${IND(8)}if len(self.q)>self.size: self.q.pop(0)`,
			`${IND(4)}def topk(self, k:int=5)->list[str]:`,
			`${IND(8)}return self.q[-k:]`,
		];
		return (Math.random()<.5?blockA:blockB).join('\n') + '\n';
	}

	// ---- RUST ----
	function genRust(){
		const Ty = ident(1).toUpperCase()+ident(5), fn = ident(), ev = ident(), q = ident();
		const blockA = [
			`use std::collections::{HashMap, VecDeque};`,
			`use tokio::time::{sleep, Duration};`,
			``,
			`#[derive(Debug, Clone)]`,
			`struct ${Ty} { id: u64, name: String, tags: Vec<String> }`,
			``,
			`async fn ${fn}(n: usize) -> Vec<${Ty}>{`,
			`${IND(4)}let mut out = Vec::new();`,
			`${IND(4)}for i in 0..n {`,
			`${IND(8)}out.push(${Ty}{ id: i as u64, name: format!("item-{i}"), tags: vec!["a".into(),"b".into()] });`,
			`${IND(4)}}`,
			`${IND(4)}out`,
			`}`,
			``,
			`#[tokio::main]`,
			`async fn main(){`,
			`${IND(4)}let mut q: VecDeque<${Ty}> = VecDeque::new();`,
			`${IND(4)}for x in ${fn}(${randInt(6,12)}).await { q.push_back(x); }`,
			`${IND(4)}let mut ix: HashMap<String, usize> = HashMap::new();`,
			`${IND(4)}while let Some(it) = q.pop_front(){`,
			`${IND(8)}*ix.entry(it.name.clone()).or_insert(0) += 1;`,
			`${IND(8)}sleep(Duration::from_millis(10)).await;`,
			`${IND(4)}}`,
			`${IND(4)}println!("size={} keys={}", q.len(), ix.len());`,
			`}`,
		];
		const blockB = [
			`#[derive(Debug)]`,
			`enum ${ev} { Start, Data(String), Error(String), End }`,
			``,
			`fn fold(mut acc: usize, e: &${ev}) -> usize {`,
			`${IND(4)}match e {`,
			`${IND(8)}${ev}::Start => 0,`,
			`${IND(8)}${ev}::Data(s) => { acc += s.len(); acc }`,
			`${IND(8)}${ev}::Error(_) => acc,`,
			`${IND(8)}${ev}::End => acc,`,
			`${IND(4)}}`,
			`}`,
			``,
			`fn main(){`,
			`${IND(4)}let stream = vec![${ev}::Start, ${ev}::Data("aaa".into), ${ev}::End];`,
			`${IND(4)}let total = stream.iter().fold(0, |a,e| fold(a,e));`,
			`${IND(4)}println!("total={}", total);`,
			`}`,
		];
		return (Math.random()<.5?blockA:blockB).join('\n') + '\n';
	}

	// ---- JAVA ----
	function genJava(){
		const Cls = ident(1).toUpperCase()+ident(7), meth = ident(), item = ident(), svc = ident();
		const blockA = [
			`final class ${Cls} {`,
			`${IND(2)}record Node(int id, String name) {}`,
			`${IND(2)}java.util.Deque<Node> dq = new java.util.ArrayDeque<>();`,
			`${IND(2)}java.util.concurrent.ExecutorService ex = java.util.concurrent.Executors.newFixedThreadPool(2);`,
			`${IND(2)}void ${meth}(int n){`,
			`${IND(4)}for(int i=0;i<n;i++) dq.addLast(new Node(i, "n"+i));`,
			`${IND(4)}ex.submit(() -> { while(!dq.isEmpty()) System.out.println(dq.pollFirst()); });`,
			`${IND(2)}}`,
			`}`,
		];
		const blockB = [
			`interface ${svc} { java.util.concurrent.CompletableFuture<String> fetch(int id); }`,
			`class Impl implements ${svc} {`,
			`${IND(2)}public java.util.concurrent.CompletableFuture<String> fetch(int id){`,
			`${IND(4)}return java.util.concurrent.CompletableFuture.supplyAsync(() -> "ok-"+id);`,
			`${IND(2)}}`,
			`}`,
			`class App {`,
			`${IND(2)}public static void main(String[] a) throws Exception {`,
			`${IND(4)}${svc} s = new Impl();`,
			`${IND(4)}var all = java.util.stream.IntStream.range(0, ${randInt(6,14)})`,
			`${IND(6)}.mapToObj(s::fetch).toList();`,
			`${IND(4)}for (var f : all) System.out.println(f.get());`,
			`${IND(2)}}`,
			`}`,
		];
		return (Math.random()<.5?blockA:blockB).join('\n') + '\n';
	}

	// ---- ASM x86 NASM ----
	function genAsm(){
		const lbl = ident(), tmp = ident();
		const block = [
			`; loop and checksum`,
			`${lbl}:`,
			`${IND(4)}xor rax, rax`,
			`${IND(4)}mov rcx, ${randInt(8,24)}`,
			`${IND(4)}lea rsi, [rel ${tmp}]`,
			`${IND(4)}.lp:`,
			`${IND(8)}add al, byte [rsi]`,
			`${IND(8)}inc rsi`,
			`${IND(8)}loop .lp`,
			`${IND(4)}ret`,
			``,
			`section .data`,
			`${tmp}: db "the-matrix", 0`,
		];
		return block.join('\n') + '\n';
	}

	// ---- SQL (PostgreSQL) ----
	function genSql(){
		const t = ident(), c1 = ident(), c2 = ident(), v = randInt(5,50);
		const blockA = [
			`WITH ${t} AS (`,
			`${IND(2)}SELECT generate_series(1, ${v}) AS id, md5(random()::text) AS ${c1}`,
			`)`,
			`SELECT id, left(${c1}, 8) AS ${c2}`,
			`FROM ${t}`,
			`WHERE id % ${randInt(2,5)} = 0`,
			`ORDER BY id;`,
		];
		const blockB = [
			`CREATE TEMP TABLE ${t}(id int, ${c1} text, ts timestamptz default now());`,
			`INSERT INTO ${t}(id, ${c1})`,
			`SELECT g, left(md5(g::text), 12) FROM generate_series(1, ${v}) g;`,
			`SELECT id, ${c1}, ts,`,
			`${IND(2)}row_number() OVER (ORDER BY id) AS rn,`,
			`${IND(2)}lag(${c1}) OVER (ORDER BY id) AS prev`,
			`FROM ${t};`,
		];
		return (Math.random()<.5?blockA:blockB).join('\n') + '\n';
	}

	rewindSpeedRange?.addEventListener('input', () => {
		const v = parseInt(rewindSpeedRange.value, 10) || 5;
		rewindSpeedVal.textContent = `x${v}`;
	});


	// toggle clean mode
	function toggleCleanMode(on){
		// While auto-typing is on, ignore manual typing keys to avoid conflicts
		if (!on) toggleStats(false);
		if (on){
			const div = document.getElementById("bigBoy")
			div.classList.add("noCursor");
			document.body.classList.add('clean');
			document.documentElement.classList.add('clean-body');

			const el = document.querySelector('.preview');
			// ask fullscreen on the preview (it's visible now)
			if (el.requestFullscreen) el.requestFullscreen().catch(()=>{});
				else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();

			preview.focus();
			// if nothing has been shown yet, at least show the initial prompt
			if (ptr === 0 && !rawText) loadExample(modeSelect.value);
				else render();
		} else {
			const div = document.getElementById("bigBoy")
			div.classList.remove("noCursor");
			document.body.classList.remove('clean');
			document.documentElement.classList.remove('clean-body');
			if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
			preview.focus();
		}
		updateCleanBtn && updateCleanBtn();
		resyncCursorAfterLayout && resyncCursorAfterLayout();
	}

	// key handling
	window.addEventListener('keydown', (ev) => {
		const isEditable = (el) => {
			if (!el) return false;
			if (el.isContentEditable) return true;
			const tag = el.tagName;
			return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';
		};
		const t = ev.target;
		const a = document.activeElement;
		if (isEditable(t) || isEditable(a)) return;

		if (ev.key === 'Shift'){ return; }
		if (ev.key === 'Control'){ return; }

		if (ev.key === 'F1'){ return; }
		// F2 = Toggles auto typing
		if (ev.key === 'F2'){
			if (ev.repeat) return;         // avoid multiple toggles when holding the key
			ev.preventDefault();
			toggleAutoTyping();
			return;
		}
		if (ev.key === 'F3'){ return; }
		// F6 = mute / unmute
		if (ev.key === 'F4'){
			soundMuted = !soundMuted;
			if (audioCtx) {
				__kb_ensureAudio();
				__kb_masterGain.gain.setTargetAtTime(
					soundMuted ? 0.0001 : masterVolume * 0.9,
					audioCtx.currentTime, 0.01
				);
			}
			const btn = document.getElementById('toggleSoundBtn');
			if (btn) {
				btn.textContent = soundMuted ? '🔇 Muted' : '🔊 Sound On';
				btn.style.opacity = soundMuted ? 0.6 : 1;
			}
			ev.preventDefault();
			return;
		}
		if (ev.key === 'F5'){ return; }
		// F6: toggle generation mode
		if (ev.key === 'F6') {
			// Se sto tentando di attivarla ma c'è un file caricato → blocca e avvisa
			const wantsOn = !generateChk.checked;
			if (wantsOn && userLoadedFile) {
				alert('Generation is disabled because a file is loaded. Clear the file to enable generation.');
				return;
			}
			generateChk.checked = wantsOn;
			// notifica i listener esistenti (mantiene la logica unica)
			generateChk.dispatchEvent(new Event('change', { bubbles: true }));
			ev.preventDefault();
			return;
		}
		// F7 = Fast mode
		if (ev.key === 'F7'){ fastMode = !fastMode; ev.preventDefault(); return; }
		// F8 = Rewind
		if (ev.key === 'F8') {
			rewindToStart();
			ev.preventDefault();
			return;
		}
		// F9 = Clean mode
		if (ev.key === 'F9'){
			cleanMode = !cleanMode;
			toggleCleanMode(cleanMode);
			ev.preventDefault();
			updateCleanBtn && updateCleanBtn();
			return;
			}
		// F10 = toggle pc stats in cleanMode
		if (ev.key === 'F10'){
			if (!document.body.classList.contains('clean')){
				alert('Stats overlay is visible only in Clean mode (F9).');
				return;
			}
			toggleStats();
			render();
			ev.preventDefault();
			return;
		}
		if (ev.key === 'F12'){ return; }

		// Backspace / Delete = Removes a character
		if (ev.key === 'Backspace' || ev.key === 'Delete') {
			ev.preventDefault();

			// ferma eventuale burst di micro-typing
			if (typeof burstTimer !== 'undefined' && burstTimer) {
				clearInterval(burstTimer);
				burstTimer = null;
			}

			if (ptr > 0) {
				ptr -= 1;
				// forza il render completo perché stiamo andando indietro
				if (typeof render === 'function') render(true);
				try { playKeySound?.(); } catch {}
			}
			return;
		}

		// ESC = Exit clean mode / clear board
		if (ev.key === 'Escape'){
			if (cleanMode){                // esci dal clean se attivo
				cleanMode = false;
				toggleCleanMode && toggleCleanMode(false);
				updateCleanBtn && updateCleanBtn();
				ev.preventDefault();
				return;
			}

			if (burstTimer){ clearInterval(burstTimer); burstTimer = null; }

			// reset testo/preview immediato
			rawText = '';
			ptr = 0;
			screen.innerHTML = '';
			userLoadedFile = false;
			warnedGenWithFile = false;

			// reset sorgente (textarea) subito, senza aspettare la digitazione
			const source = document.getElementById('source');
			source && (source.value = examples.code);

			// reset file di testo
			const fileInput = document.getElementById('fileInput');
			fileInput && (fileInput.value = '');

			// cursore all'inizio
			if (typeof cursor !== 'undefined'){
				cursor.style.top = '0px';
				cursor.style.left = '0px';
			}

			// ridisegna subito
			(typeof scheduleRender === 'function' ? scheduleRender : (typeof render==='function'&&render))?.();

			hideOverlay?.();
			ev.preventDefault();
			return;
		}

		if (ev.code === (window.rewindHotkey || 'Home')) {
			ev.preventDefault();
			rewindToStart();
			return;
		}

		type(ev);

		ev.preventDefault();

		if (!rawText) loadExample(modeSelect.value);
	});

	function type(ev){
		// calcola il chunk
		const before = ptr;
		let chunk = parseInt((chunkRange && chunkRange.value) || '4', 10) || 4;
		if (fastMode) chunk = Math.min(40, chunk * 4);
		if (ev.code === 'Space') chunk *= 3;


		// interrompi un eventuale burst ancora in corso
		if (burstTimer){ clearInterval(burstTimer); burstTimer = null; }

		const maxCanType = rawText.length - ptr;

		// se chunk <= 1 (o siamo a fine buffer) → singolo carattere
		if (chunk <= 1 || maxCanType <= 1){
			if (maxCanType > 0){
				ptr += 1;
				render();
				try{ playKeySound?.(); }catch{}
			}
			if (ptr === rawText.length) maybeGenerateNextBlock?.();
		} else {
			// micro-typing: n caratteri uno dopo l’altro
			burstLeft = Math.min(chunk, maxCanType);
			burstTimer = setInterval(() => {
				if (burstLeft <= 0){
					clearInterval(burstTimer); burstTimer = null;
					if (ptr === rawText.length) maybeGenerateNextBlock?.();
					return;
				}
				ptr += 1;
				render(true);
				try{ playKeySound?.(); }catch{}
				burstLeft--;
			}, burstDelayMs);
		}

	}

	// re-focus when fullscreen state changes
	document.addEventListener('fullscreenchange', () => {
		if (document.fullscreenElement) {
			preview.focus();
		}
	});

	fontSizeRange.addEventListener('input', () => {
		const size = fontSizeRange.value;
		fontSizeVal.textContent = `${size}px`;
		document.querySelectorAll('#screen, #source, #cursor').forEach(el => {
			el.style.fontSize = `${size}px`;
		});

		// update cursor right away (updates --lh via render pipeline)
		resyncCursorAfterLayout && resyncCursorAfterLayout()
	});

	fontSelect?.addEventListener('change', () => {
		const val = fontSelect.value;

		// If the option uses a CSS var stack (e.g., var(--ui-orbitron)), apply it directly.
		if (val && val.startsWith('var(')) {
			const scope = document.querySelector('.left') || document.body;
			scope.style.setProperty('--code-mono', val);

			if (document.fonts?.ready) {
				document.fonts.ready.then(() => resyncCursorAfterLayout?.());
			} else {
				setTimeout(() => resyncCursorAfterLayout?.(), 60);
			}
			return;
		}

		// Otherwise fall back to name-based selection (loads via GOOGLE_FONTS if mapped)
		const fontName = fontSelect.options[fontSelect.selectedIndex]?.text || 'JetBrains Mono';
		setFont(fontName);

		if (document.fonts?.ready) {
			document.fonts.ready.then(() => resyncCursorAfterLayout?.());
		} else {
			setTimeout(() => resyncCursorAfterLayout?.(), 60);
		}
	});

	function updateCleanBtn(){
		if (!cleanBtn) return;
		const isOn = document.body.classList.contains('clean');
		cleanBtn.textContent = isOn ? 'Exit Only Code' : '⛶ Fullscreen';
		cleanBtn.setAttribute('aria-pressed', String(isOn));
	}

	cleanBtn?.addEventListener('click', (ev) => {
		ev.preventDefault();
		cleanMode = !cleanMode;                 // usa la tua variabile esistente
		toggleCleanMode && toggleCleanMode(cleanMode);
		updateCleanBtn();
	});

	loadExample('code');
	updateCleanBtn();

	document.addEventListener('fullscreenchange', resyncCursorAfterLayout);
	window.addEventListener('resize', resyncCursorAfterLayout);

	const y = document.getElementById('copyright-year');
	if (y) y.textContent = '© ' + new Date().getFullYear();
})();

// --- Suono tastiera con upload personalizzato e toggle ---
let soundMuted = false;
let customSoundBuffer = null;
let useCustomSound = false;
let audioCtx = null;
const volumeRange = document.getElementById('volumeRange');
const volumeVal = document.getElementById('volumeVal');
let masterVolume = 0.5;

volumeRange.addEventListener('input', () => {
	masterVolume = volumeRange.value / 100;
	volumeVal.textContent = `${volumeRange.value}%`;
	if (audioCtx) {
		__kb_ensureAudio();
		__kb_masterGain.gain.setTargetAtTime(
			soundMuted ? 0.0001 : masterVolume * 0.9,
			audioCtx.currentTime, 0.01
		);
	}
});

// ===== Master chain (compressor + master gain) =====
let __kb_masterGain = null;
let __kb_compressor = null;
let __kb_noiseBuf = null;

function __kb_ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (!__kb_masterGain) {
    __kb_masterGain = audioCtx.createGain();
    __kb_masterGain.gain.value = soundMuted ? 0.0001 : (masterVolume * 0.9);

    __kb_compressor = audioCtx.createDynamicsCompressor();
    __kb_compressor.threshold.value = -12;
    __kb_compressor.knee.value = 20;
    __kb_compressor.ratio.value = 6;
    __kb_compressor.attack.value = 0.002;
    __kb_compressor.release.value = 0.03;

    __kb_compressor.connect(__kb_masterGain).connect(audioCtx.destination);
  }
}

function __kb_makeNoiseBuffer() {
  // Short, high-damped burst to emulate switch “click”
  const sr = audioCtx.sampleRate;
  const len = Math.floor(sr * 0.02);
  const buf = audioCtx.createBuffer(1, len, sr);
  const data = buf.getChannelData(0);
  for (let i = 0; i < len; i++) {
    const t = i / len;
    // slightly colored noise + strong exponential damping towards the end
    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - t, 6);
  }
  return buf;
}

// Default keyboard click = noise burst + short blip + soft thock
function playDefaultClick() {
  if (soundMuted) return;
  __kb_ensureAudio();
  if (audioCtx.state === 'suspended') audioCtx.resume();

  const now = audioCtx.currentTime;

  // 1) Noise burst (the "click")
  if (!__kb_noiseBuf) __kb_noiseBuf = __kb_makeNoiseBuffer();
  const noise = audioCtx.createBufferSource();
  noise.buffer = __kb_noiseBuf;
  const nGain = audioCtx.createGain();
  nGain.gain.setValueAtTime(0, now);
  nGain.gain.linearRampToValueAtTime(0.18 * masterVolume, now + 0.002);
  nGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);
  noise.connect(nGain).connect(__kb_compressor);
  noise.start(now);

  // 2) Short square blip (very quick, decaying pitch)
  const osc = audioCtx.createOscillator();
  osc.type = 'square';
  const f0 = 2500 + Math.random() * 500;
  osc.frequency.setValueAtTime(f0, now);
  osc.frequency.linearRampToValueAtTime(1300, now + 0.012);
  const oGain = audioCtx.createGain();
  oGain.gain.setValueAtTime(0, now);
  oGain.gain.linearRampToValueAtTime(0.10 * masterVolume, now + 0.0015);
  oGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);
  osc.connect(oGain).connect(__kb_compressor);
  osc.start(now);
  osc.stop(now + 0.035);

  // 3) Low "thock" tail (soft, very short)
  const th = audioCtx.createOscillator();
  th.type = 'sine';
  th.frequency.setValueAtTime(180 + Math.random() * 20, now);
  const tGain = audioCtx.createGain();
  tGain.gain.setValueAtTime(0, now);
  tGain.gain.linearRampToValueAtTime(0.08 * masterVolume, now + 0.004);
  tGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.06);
  th.connect(tGain).connect(__kb_compressor);
  th.start(now);
  th.stop(now + 0.07);
}

// Custom file playback goes through the same master chain
async function playCustomSound() {
  if (soundMuted || !customSoundBuffer) return;
  __kb_ensureAudio();
  if (audioCtx.state === 'suspended') await audioCtx.resume();

  const source = audioCtx.createBufferSource();
  source.buffer = customSoundBuffer;

  // Optional per-file gain; master volume is handled by the master gain
  const g = audioCtx.createGain();
  g.gain.value = 1.0;

  source.connect(g).connect(__kb_compressor);
  source.start(0);
}

// riproduci il suono corretto
function playKeySound() {
	if (useCustomSound && customSoundBuffer) playCustomSound();
		else playDefaultClick();
}

// gestisci caricamento file
const soundFileInput = document.getElementById('soundFileInput');
const soundFileLabel = document.getElementById('soundFileLabel');
soundFileInput.addEventListener('change', async e => {
	const file = e.target.files?.[0];
	if (!file) return;
	const arrayBuffer = await file.arrayBuffer();
	if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
	customSoundBuffer = await audioCtx.decodeAudioData(arrayBuffer);
	useCustomSound = true;
	soundFileLabel.textContent = `Custom: ${file.name}`;
});

// bottone mute/unmute
const toggleSoundBtn = document.getElementById('toggleSoundBtn');
toggleSoundBtn.addEventListener('click', () => {
	soundMuted = !soundMuted;
	if (audioCtx) {
		__kb_ensureAudio();
		__kb_masterGain.gain.setTargetAtTime(
			soundMuted ? 0.0001 : masterVolume * 0.9,
			audioCtx.currentTime, 0.01
		);
	}
	toggleSoundBtn.textContent = soundMuted ? '🔇 Muted' : '🔊 Sound On';
	toggleSoundBtn.style.opacity = soundMuted ? 0.6 : 1;
});

const GOOGLE_FONTS = {
	"JetBrains Mono": "JetBrains+Mono:wght@400;600",
	"Ubuntu Mono": "Ubuntu+Mono:wght@400;700",
	"Anonymous Pro": "Anonymous+Pro:wght@400;700",
	"Major Mono Display": "Major+Mono+Display",
	"Nova Mono": "Nova+Mono",
	"VT323": "VT323",
	"Orbitron": "Orbitron:wght@400;600;700",
	"Pixelify Sans": "Pixelify+Sans:wght@400;700",
	"Bungee": "Bungee",
	"Audiowide": "Audiowide",
	"Iceland": "Iceland",
	"Megrim": "Megrim",
	"Syncopate": "Syncopate:wght@400;700"
};

function ensureGoogleFont(fq) {
	const id = `fontlink-${fq}`;
	if (!document.getElementById(id)) {
		const link = document.createElement('link');
		link.id = id;
		link.rel = 'stylesheet';
		link.href = `https://fonts.googleapis.com/css2?family=${fq}&display=swap`;
		document.head.appendChild(link);
	}
}

function setFont(fontName) {
	const fq = GOOGLE_FONTS[fontName] || null;
	if (fq) ensureGoogleFont(fq);

	const family = `"${fontName}", monospace`;

	const scope = document.querySelector('.left') || document.body;
	scope.style.setProperty('--code-mono', family);

	if (document.fonts && document.fonts.load) {
		document.fonts.load(`16px "${fontName}"`).catch(()=>{});
	}
}

// === Text Color ===
const colorSwatches = document.getElementById('colorSwatches');
const colorHexInput = document.getElementById('colorHexInput');
const applyColorBtn = document.getElementById('applyColorBtn');
const monoColorChk = document.getElementById('monoColor');
const THEMES = {
	// 1) Default Neon → background "default"
	default: {
		code:"#b6ffb6",
		kw:"#7fffb5", type:"#7ee0ff", str:"#ffd19a", num:"#ffb3b3",
		comment:"#6a7b6a", fn:"#ffd1ff", punct:"#cfe8ff", loglevel:"#ffb86b",
		bgPreset:"default"
	},

	// 2) Monokai Black → background "solid-black"
	monokaiBlack: {
		code:"#f8f8f2",
		kw:"#f92672", type:"#66d9ef", str:"#e6db74", num:"#ae81ff",
		comment:"#75715e", fn:"#a6e22e", punct:"#cfcfc2", loglevel:"#fd971f",
		bgPreset:"solid-black"
	},

	// 3) Matrix Green → background "deep-green"
	matrixGreen: {
		code:     "#AFFF8C",  // base text verde chiaro
		kw:       "#39FF14",  // keyword neon
		type:     "#7DE3FF",  // tipi in ciano (leggera variazione)
		str:      "#B9FF9E",  // stringhe verde latte
		num:      "#AEFFB8",  // numeri mint
		comment:  "#355a35",  // commenti verdone spento
		fn:       "#9AE6C7",  // funzioni verde-azzurro
		punct:    "#AFFF8C",
		loglevel: "#B4FF6E",
		bgPreset: "solid-black", // sfondo coerente
	},

	// 4) Terminal Sea → background "terminal-ice"
	terminalSea: {
		code:"#dbe8f1",
		kw:"#268bd2", type:"#6fb1ff", str:"#ffd479", num:"#c792ea",
		comment:"#7a8b9a", fn:"#9ce19d", punct:"#cfe3ff", loglevel:"#ff9f1c",
		bgPreset:"terminal-ice"
	},

	// 5) Carbon Warm → background "carbon"
	carbonWarm: {
		code:"#ebdbb2",
		kw:"#fb4934", type:"#83a598", str:"#fabd2f", num:"#d3869b",
		comment:"#928374", fn:"#b8bb26", punct:"#ebdbb2", loglevel:"#fe8019",
		bgPreset:"carbon"
	},

	// 6) Dracula Glass → background "terminal-glass"
	draculaGlass: {
		code:"#f8f8f2",
		kw:"#ff79c6", type:"#8be9fd", str:"#f1fa8c", num:"#bd93f9",
		comment:"#6272a4", fn:"#50fa7b", punct:"#f8f8f2", loglevel:"#ffb86c",
		bgPreset:"terminal-glass"
	}
};

// --- Tabs per #colorPanel ---
function initColorTabs(){
	const panel = document.getElementById('colorPanel');
	if (!panel) return;
	const btns = panel.querySelectorAll('.tab-btn');
	const tabs = panel.querySelectorAll('.tab-content');

	btns.forEach(btn=>{
		btn.addEventListener('click', ()=>{
			btns.forEach(b=>b.classList.remove('active'));
			tabs.forEach(t=>t.classList.add('hidden'));
			btn.classList.add('active');
			const id = btn.getAttribute('data-tab');
			const tab = panel.querySelector('#'+id);
			if (tab) tab.classList.remove('hidden');
		});
	});
}

// --- Background presets only for the PREVIEW panel ---
const previewEl = document.getElementById('preview');

function applyPreviewBgFromPreset(name){
	if (!previewEl) return;

	// reset base + remove visual tweaks
	previewEl.style.background = '';
	previewEl.style.backdropFilter = '';
	previewEl.classList.remove('bg-solid');

	switch(name){
		case 'solid-black':
			previewEl.style.background = '#000';
			previewEl.classList.add('bg-solid');
			break;
		case 'deep-green':
			previewEl.style.background =
				'radial-gradient(circle at 20% 15%, rgba(57,255,20,0.06), transparent 40%), #04140a';
			break;
		case 'carbon':
			previewEl.style.background =
				'repeating-linear-gradient(45deg, #0b0b0b 0 6px, #0f0f0f 6px 12px)';
			break;
		case 'terminal-ice':
			previewEl.style.background = `radial-gradient(circle at 50% 35%, rgba(180,240,255,0.15), rgba(0,0,0,0.0) 70%), radial-gradient(circle at 80% 80%, rgba(120,200,255,0.08), rgba(0,0,0,0.0) 75%), linear-gradient(180deg, rgba(15,20,25,0.85), rgba(5,5,8,0.95)), #081014`;
			previewEl.style.backdropFilter = 'blur(7px) saturate(125%) contrast(110%) brightness(1.05)';
			previewEl.style.boxShadow = 'inset 0 0 25px rgba(0,0,0,0.6), 0 0 40px rgba(180,240,255,0.12)';
			break;
		case 'terminal-glass':
			previewEl.style.background = `radial-gradient(circle at 25% 15%, rgba(255,255,255,0.05), rgba(255,255,255,0.0) 70%), radial-gradient(circle at 75% 85%, rgba(255,255,255,0.04), rgba(0,0,0,0.0) 80%), linear-gradient(180deg, rgba(10,12,14,0.85), rgba(0,0,0,0.95)), #0b0d10`;
			previewEl.style.backdropFilter = 'blur(7px) saturate(115%) contrast(108%)';
			previewEl.style.boxShadow = 'inset 0 0 25px rgba(0,0,0,0.6), 0 0 30px rgba(0,0,0,0.4)';
			break;
		case 'default':
		default:
			// il tuo default: leggero radial + base #051016
			previewEl.style.background =
				'#051016'; 
			break;
	}
}

function applySolidBg(hex){
	if (!previewEl) return;
	previewEl.style.background = hex;
	previewEl.style.backdropFilter = '';
}

// overlays (scanlines/vignette) prese dalle checkbox
function updateBgOverlaysFromUI(){
	const sl = document.getElementById('bgScanlinesChk')?.checked;
	const vg = document.getElementById('bgVignetteChk')?.checked;
	if (!previewEl) return;
	previewEl.classList.toggle('bg-scanlines', !!sl);
	previewEl.classList.toggle('bg-vignette', !!vg);
}

// --- Wiring eventi per la TAB Background ---
(function wireBackgroundTab(){
	const grid = document.getElementById('bgGrid');
	const hex = document.getElementById('bgHexInput');
	const btn = document.getElementById('applyBgHexBtn');
	const sl  = document.getElementById('bgScanlinesChk');
	const vg  = document.getElementById('bgVignetteChk');

	function setActiveBgPresetUI(preset){
		grid?.querySelectorAll('.bg-tile').forEach(el=>{
			el.classList.toggle('active', el.dataset.preset === preset);
		});
	}

	grid?.addEventListener('click', (e)=>{
		const el = e.target.closest('.bg-tile');
		if (!el) return;
		const preset = el.dataset.preset;
		applyPreviewBgFromPreset(preset);   // usa la tua funzione esistente
		setActiveBgPresetUI(preset);
	});

	btn?.addEventListener('click', ()=>{
		const v = normalizeHex(hex?.value);
		if (v) applySolidBg(v);             // tinta unita personalizzata
	});
	hex?.addEventListener('keydown', (e)=>{
		if (e.key === 'Enter'){
			const v = normalizeHex(hex.value);
			if (v) applySolidBg(v);
		}
		e.stopPropagation();                // così i tasti non “scrivono” nella preview
	});

	sl?.addEventListener('change', updateBgOverlaysFromUI);
	vg?.addEventListener('change', updateBgOverlaysFromUI);

	// Stato iniziale
	applyPreviewBgFromPreset('default');
	setActiveBgPresetUI('default');
	updateBgOverlaysFromUI();

	// opzionale: esponi l’API per i Theme presets (se li usi per cambiare anche lo sfondo)
	window.setActiveBgPresetUI = setActiveBgPresetUI;
})();

// --- Attiva le tabs all'avvio (chiama dopo che il DOM c'è) ---
initColorTabs();

// --- Theme buttons nella tab 3 (riusano applyTheme esistente) ---
document.querySelectorAll('#tabThemes .theme-btn').forEach(btn=>{
	btn.addEventListener('click', ()=>applyTheme(btn.dataset.theme));
});


function applyTheme(name){
	const t = THEMES[name];
	if (!t) return;

	const scope = document.querySelector('.left') || document.body;

	// colore base testo (preview + source) e cursore
	scope.style.setProperty('--code-color', t.code);
	scope.style.setProperty('--cursor-color', t.code);

	// palette sintassi
	scope.style.setProperty('--kw', t.kw);
	scope.style.setProperty('--type', t.type);
	scope.style.setProperty('--str', t.str);
	scope.style.setProperty('--num', t.num);
	scope.style.setProperty('--comment', t.comment);
	scope.style.setProperty('--fn', t.fn);
	scope.style.setProperty('--punct', t.punct);
	scope.style.setProperty('--loglevel', t.loglevel);

	// riflette il color base nell'input HEX, se presente
	if (typeof colorHexInput !== 'undefined' && colorHexInput) {
		colorHexInput.value = t.code;
	}

	// aggiorna anche lo SFONDO della preview
	if (t.bgPreset && typeof applyPreviewBgFromPreset === 'function') {
		applyPreviewBgFromPreset(t.bgPreset);
		if (typeof window.setActiveBgPresetUI === 'function'){
			window.setActiveBgPresetUI(t.bgPreset); // evidenzia il tile
		}
	}

	if (typeof render === 'function') render();
}

function setCodeColor(hex){
	const scope = document.querySelector('.left') || document.body;
	scope.style.setProperty('--code-color', hex);
	scope.style.setProperty('--cursor-color', hex);   // cursore = stesso colore
}

function normalizeHex(v){
	if (!v) return null;
	let s = v.trim().toLowerCase();
	if (!s.startsWith('#')) s = '#' + s;
	// #rgb -> #rrggbb
	if (/^#([0-9a-f]{3})$/.test(s)){
		s = s.replace(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/, (_,r,g,b)=>`#${r}${r}${g}${g}${b}${b}`);
	}
	if (!/^#([0-9a-f]{6})$/.test(s)) return null;
	return s;
}

// click su palette
if (colorSwatches){
	colorSwatches.addEventListener('click', (e)=>{
		const btn = e.target.closest('.swatch');
		if (!btn) return;
		const hex = btn.getAttribute('data-color');
		if (hex) {
			setCodeColor(hex);
			colorHexInput && (colorHexInput.value = hex);
		}
	});
}

// apply da input HEX
if (applyColorBtn){
	applyColorBtn.addEventListener('click', ()=>{
		const hex = normalizeHex(colorHexInput?.value || '');
		if (hex) setCodeColor(hex);
			else alert('Insert a valid HEX (#39ff14 o #3f3)');
	});
}

// invio su input HEX
if (colorHexInput){
	colorHexInput.addEventListener('keydown', (ev)=>{
		if (ev.key === 'Enter'){
			const hex = normalizeHex(colorHexInput.value);
			if (hex) setCodeColor(hex);
				else alert('Insert a valid HEX (#39ff14 o #3f3)');
		}
	});
}

// toggle monocolore
if (monoColorChk){
	monoColorChk.addEventListener('change', ()=>{
		const preview = document.querySelector('.preview');
		if (!preview) return;
		preview.classList.toggle('mono', monoColorChk.checked);
		// re-render per applicare eventuali nuove classi
		render && render();
	});
}

const themePresets = document.getElementById('themePresets');
if (themePresets){
	themePresets.addEventListener('click', (e)=>{
		const btn = e.target.closest('.theme-btn');
		if (!btn) return;
		applyTheme(btn.dataset.theme);
	});
}

// === RESET AUDIO ===
const resetAudioBtn = document.getElementById('resetAudioBtn');
function resetAudio(){
	// torna al click generato via Web Audio
	customSoundBuffer = null;   // <— niente window.
	useCustomSound   = false;   // <— niente window.

	// pulisci input e label
	if (soundFileInput)  soundFileInput.value = '';
	if (soundFileLabel)  soundFileLabel.textContent = 'Default click';
}
resetAudioBtn && resetAudioBtn.addEventListener('click', resetAudio);

/* ===== Fake system stats (Clean mode, F10) ===== */
let statsOn = false;
let statsTick = null;
let startedAt = Date.now();

const BUF = 180; // ~ ultimi 180 campioni
const cpuData = Array(BUF).fill(0.2);
const memUsed = Array(BUF).fill(3.2);      // GB
const memCache = Array(BUF).fill(1.2);     // GB
const memTotalGB = 8;
const netUp = Array(BUF).fill(0.2);        // MB/s
const netDown = Array(BUF).fill(0.4);      // MB/s

// STACK fake
const stackLines = [];
let spAddr = 0x00007ffdf000;    // base finta
function hex(n,len=12){ return '0x' + n.toString(16).padStart(len,'0'); }
function randByte(){ return Math.floor(Math.random()*256); }
function randWord(){ return Array.from({length:8}, ()=>randByte()); }
function renderStack(){
	// mantieni 10-12 righe
	const max = 12;
	while (stackLines.length>max) stackLines.shift();
	const el = document.getElementById('stackView');
	if (!el) return;
	el.textContent = stackLines.join('\n');
}

function pushStackRow(){
	// una riga = indirizzo crescente e 8 byte + commento registro random
	const bytes = randWord();
	const addr = hex(spAddr, 12);
	const hexs = bytes.map(b=>b.toString(16).padStart(2,'0')).join(' ');
	const regs = ['rax','rbx','rcx','rdx','rsi','rdi','rbp','rip'];
	const comment = regs[Math.floor(Math.random()*regs.length)];
	stackLines.push(`${addr}  ${hexs}   ; ${comment}`);
	spAddr += 0x10; // avanza
	renderStack();
}

// canvases
const $cpuC = document.getElementById('cpuChart');
const $memC = document.getElementById('memChart');
const $netC = document.getElementById('netChart');

function rndWalk(v, min, max, step=0.05){
	v += (Math.random()*2 - 1) * step;
	if (v < min) v = min + (min - v)*0.2;
	if (v > max) v = max - (v - max)*0.2;
	return v;
}
function push(buf, val){ buf.push(val); if (buf.length>BUF) buf.shift(); }

function drawLine(ctx, data, color){
	const {width, height} = ctx.canvas;
	ctx.clearRect(0,0,width,height);
	// grid
	ctx.globalAlpha = 0.35;
	ctx.strokeStyle = 'rgba(255,255,255,0.08)';
	ctx.lineWidth = 1;
	for(let i=1;i<4;i++){
		const y = (height/4)*i + .5;
		ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke();
	}
	// line
	ctx.globalAlpha = 1;
	ctx.strokeStyle = color;
	ctx.lineWidth = 1.5;
	ctx.beginPath();
	for(let i=0;i<data.length;i++){
		const x = (i/(data.length-1)) * (width-2) + 1;
		const y = height - (data[i] * (height-2)) - 1;
		if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
	}
	ctx.stroke();
}

function drawMem(ctx, usedGB, cacheGB){
	const {width, height} = ctx.canvas;
	ctx.clearRect(0,0,width,height);
	const usedNorm = usedGB.map(v => v / memTotalGB);
	const cacheNorm = cacheGB.map(v => v / memTotalGB);
	// grid
	ctx.globalAlpha = 0.35;
	ctx.strokeStyle = 'rgba(255,255,255,0.08)';
	ctx.lineWidth = 1;
	for(let i=1;i<4;i++){
		const y = (height/4)*i + .5;
		ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke();
	}
	// cache
	ctx.globalAlpha = 0.9;
	ctx.strokeStyle = '#55ccff';
	ctx.lineWidth = 1.2;
	ctx.beginPath();
	for(let i=0;i<cacheNorm.length;i++){
		const x = (i/(cacheNorm.length-1))*(width-2)+1;
		const y = height - (cacheNorm[i]*(height-2)) - 1;
		if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
	}
	ctx.stroke();
	// used
	ctx.strokeStyle = '#39ff14';
	ctx.beginPath();
	for(let i=0;i<usedNorm.length;i++){
		const x = (i/(usedNorm.length-1))*(width-2)+1;
		const y = height - (usedNorm[i]*(height-2)) - 1;
		if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
	}
	ctx.stroke();
}

function fmtUptime(ms){
	const s = Math.floor(ms/1000);
	const d = Math.floor(s/86400);
	const h = String(Math.floor((s%86400)/3600)).padStart(2,'0');
	const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
	const ss = String(s%60).padStart(2,'0');
	return `${d}d ${h}:${m}:${ss}`;
}

function tickStats(){
	// CPU (0..1)
	const lastCpu = cpuData[cpuData.length-1];
	const cpu = rndWalk(lastCpu, 0.05, 0.95, 0.08);
	push(cpuData, cpu);

	// Memoria
	const lastU = memUsed[memUsed.length-1];
	const lastC = memCache[memCache.length-1];
	const u = rndWalk(lastU, 1.4, 6.6, 0.18);
	const c = rndWalk(lastC, 0.4, 2.4, 0.10);
	push(memUsed, u); push(memCache, c);

	// Rete
	const lastUp = netUp[netUp.length-1];
	const lastDn = netDown[netDown.length-1];
	const up = rndWalk(lastUp, 0.0, 3.0, 0.35);
	const dn = rndWalk(lastDn, 0.0, 6.0, 0.55);
	push(netUp, up); push(netDown, dn);

	// Stack line
	pushStackRow();

	// Disegno
	drawLine($cpuC.getContext('2d'), cpuData, '#39ff14');
	drawMem($memC.getContext('2d'), memUsed, memCache);
	const netSum = netDown.map((v,i)=> (v+netUp[i])/10);
	drawLine($netC.getContext('2d'), netSum, '#7ee0ff');

	// Labels
	document.getElementById('cpuNow').textContent = cpu.toFixed(2);
	const avg1 = cpuData.slice(-60).reduce((a,b)=>a+b,0)/Math.min(60,cpuData.length);
	const avg5 = cpuData.slice(-150).reduce((a,b)=>a+b,0)/Math.min(150,cpuData.length);
	const avg15 = cpuData.reduce((a,b)=>a+b,0)/cpuData.length;
	document.getElementById('cpuAvg').textContent = `${avg1.toFixed(2)} / ${avg5.toFixed(2)} / ${avg15.toFixed(2)}`;

	document.getElementById('memNow').textContent = `${u.toFixed(1)} / ${memTotalGB.toFixed(1)} GB`;
	const free = Math.max(0, memTotalGB - u - c);
	document.getElementById('memBreak').textContent = `${u.toFixed(1)} used • ${c.toFixed(1)} cache • ${free.toFixed(1)} free`;

	document.getElementById('netNow').textContent = `↑ ${up.toFixed(1)} MB/s • ↓ ${dn.toFixed(1)} MB/s`;
	document.getElementById('uptimeLbl').textContent = fmtUptime(Date.now() - startedAt);
}

function startStats(){ if (!statsTick){ tickStats(); statsTick = setInterval(tickStats, 250); } }
function stopStats(){ if (statsTick){ clearInterval(statsTick); statsTick = null; } }

function toggleStats(force){
	const next = typeof force === 'boolean' ? force : !statsOn;
	statsOn = next;
	document.body.classList.toggle('stats-on', statsOn);
	if (statsOn && document.body.classList.contains('clean')) startStats();
		else stopStats();
}

/* Uscita dalla Clean: spegni stats */
document.addEventListener('fullscreenchange', () => {
	if (!document.fullscreenElement) toggleStats(false);
});

/* Se hai una toggleCleanMode(on), assicurati di spegnere stats in off:
   if (!on) toggleStats(false); */

		</script>
	</body>
</html>
